<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¤è¯ç³»ç»Ÿæµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 2rem;
            margin: 1rem 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #333;
            margin-bottom: 1rem;
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 14px;
        }
        .test-button:hover {
            background: #5a6fd8;
        }
        .test-result {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            color: #27ae60;
        }
        .error {
            color: #e74c3c;
        }
        .user-info {
            background: #e8f4fd;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Supabase è®¤è¯ç³»ç»Ÿæµ‹è¯•</h1>
    
    <!-- é…ç½®æµ‹è¯• -->
    <div class="test-section">
        <h2>1. é…ç½®æµ‹è¯•</h2>
        <button class="test-button" onclick="testConfig()">æµ‹è¯• Supabase è¿æ¥</button>
        <div id="config-result" class="test-result hidden"></div>
    </div>

    <!-- è®¤è¯æµ‹è¯• -->
    <div class="test-section">
        <h2>2. è®¤è¯æµ‹è¯•</h2>
        <div>
            <input type="text" id="testUsername" placeholder="æµ‹è¯•ç”¨æˆ·å" value="testuser">
            <input type="password" id="testPassword" placeholder="æµ‹è¯•å¯†ç " value="123456">
        </div>
        <button class="test-button" onclick="testRegister()">æµ‹è¯•æ³¨å†Œ</button>
        <button class="test-button" onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
        <button class="test-button" onclick="testLogout()">æµ‹è¯•é€€å‡º</button>
        <div id="auth-result" class="test-result hidden"></div>
    </div>

    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <div class="test-section">
        <h2>3. ç”¨æˆ·ä¿¡æ¯</h2>
        <div id="user-info" class="user-info hidden">
            <p><strong>ç”¨æˆ·ID:</strong> <span id="user-id"></span></p>
            <p><strong>ç”¨æˆ·å:</strong> <span id="user-name"></span></p>
            <p><strong>ç§¯åˆ†:</strong> <span id="user-points"></span></p>
        </div>
        <button class="test-button" onclick="getUserInfo()">è·å–ç”¨æˆ·ä¿¡æ¯</button>
        <div id="user-result" class="test-result hidden"></div>
    </div>

    <!-- ç§¯åˆ†æµ‹è¯• -->
    <div class="test-section">
        <h2>4. ç§¯åˆ†ç³»ç»Ÿæµ‹è¯•</h2>
        <button class="test-button" onclick="testCheckPoints()">æ£€æŸ¥ç§¯åˆ†</button>
        <button class="test-button" onclick="testConsumePoints()">æ¶ˆè´¹ç§¯åˆ† (10)</button>
        <button class="test-button" onclick="testRewardPoints()">å¥–åŠ±ç§¯åˆ† (5)</button>
        <div id="points-result" class="test-result hidden"></div>
    </div>

    <!-- API æµ‹è¯• -->
    <div class="test-section">
        <h2>5. åç«¯ API æµ‹è¯•</h2>
        <button class="test-button" onclick="testBackendAPI()">æµ‹è¯•åç«¯è¿æ¥</button>
        <div id="api-result" class="test-result hidden"></div>
    </div>

    <script>
        // Supabaseé…ç½®
        const SUPABASE_URL = 'https://bqbtkaljxsmdcpedrerg.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxYnRrYWxqeHNtZGNwZWRyZXJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NDg0NDUsImV4cCI6MjA3NDAyNDQ0NX0._XIcJcSg_00b_iOs90QM5GNaKAg5_LEHGDrexDTFcMQ'
        
        const { createClient } = supabase
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY)

        let currentUser = null

        // æµ‹è¯•é…ç½®
        async function testConfig() {
            const resultDiv = document.getElementById('config-result')
            resultDiv.classList.remove('hidden')
            
            try {
                resultDiv.textContent = 'æ­£åœ¨æµ‹è¯• Supabase è¿æ¥...'
                
                // æµ‹è¯•è¿æ¥
                const { data, error } = await supabaseClient.auth.getSession()
                
                if (error) {
                    resultDiv.innerHTML = `<span class="error">è¿æ¥å¤±è´¥: ${error.message}</span>`
                } else {
                    resultDiv.innerHTML = `<span class="success">âœ… Supabase è¿æ¥æˆåŠŸï¼</span>`
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">è¿æ¥å¤±è´¥: ${error.message}</span>`
            }
        }

        // æµ‹è¯•æ³¨å†Œ
        async function testRegister() {
            const resultDiv = document.getElementById('auth-result')
            resultDiv.classList.remove('hidden')
            
            const username = document.getElementById('testUsername').value
            const password = document.getElementById('testPassword').value
            
            try {
                resultDiv.textContent = 'æ­£åœ¨æ³¨å†Œ...'
                
                const { data, error } = await supabaseClient.auth.signUp({
                    email: `${username}@temp.com`,
                    password: password,
                    options: {
                        data: { username: username }
                    }
                })
                
                if (error) {
                    resultDiv.innerHTML = `<span class="error">æ³¨å†Œå¤±è´¥: ${error.message}</span>`
                } else {
                    resultDiv.innerHTML = `<span class="success">âœ… æ³¨å†ŒæˆåŠŸï¼ç”¨æˆ·ID: ${data.user?.id}</span>`
                    currentUser = data.user
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">æ³¨å†Œå¤±è´¥: ${error.message}</span>`
            }
        }

        // æµ‹è¯•ç™»å½•
        async function testLogin() {
            const resultDiv = document.getElementById('auth-result')
            resultDiv.classList.remove('hidden')
            
            const username = document.getElementById('testUsername').value
            const password = document.getElementById('testPassword').value
            
            try {
                resultDiv.textContent = 'æ­£åœ¨ç™»å½•...'
                
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: `${username}@temp.com`,
                    password: password
                })
                
                if (error) {
                    resultDiv.innerHTML = `<span class="error">ç™»å½•å¤±è´¥: ${error.message}</span>`
                } else {
                    resultDiv.innerHTML = `<span class="success">âœ… ç™»å½•æˆåŠŸï¼</span>`
                    currentUser = data.user
                    await getUserInfo()
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">ç™»å½•å¤±è´¥: ${error.message}</span>`
            }
        }

        // æµ‹è¯•é€€å‡º
        async function testLogout() {
            const resultDiv = document.getElementById('auth-result')
            resultDiv.classList.remove('hidden')
            
            try {
                await supabaseClient.auth.signOut()
                resultDiv.innerHTML = `<span class="success">âœ… é€€å‡ºæˆåŠŸï¼</span>`
                currentUser = null
                document.getElementById('user-info').classList.add('hidden')
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">é€€å‡ºå¤±è´¥: ${error.message}</span>`
            }
        }

        // è·å–ç”¨æˆ·ä¿¡æ¯
        async function getUserInfo() {
            const resultDiv = document.getElementById('user-result')
            resultDiv.classList.remove('hidden')
            
            try {
                const { data: { user } } = await supabaseClient.auth.getUser()
                
                if (!user) {
                    resultDiv.innerHTML = `<span class="error">æœªç™»å½•</span>`
                    document.getElementById('user-info').classList.add('hidden')
                    return
                }

                // è°ƒç”¨åç«¯APIè·å–ç”¨æˆ·ä¿¡æ¯
                const response = await fetch('/auth/user', {
                    headers: {
                        'Authorization': `Bearer ${await supabaseClient.auth.getSession().then(s => s.data.session?.access_token)}`
                    }
                })

                if (response.ok) {
                    const userData = await response.json()
                    resultDiv.innerHTML = `<span class="success">âœ… è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ</span>`
                    
                    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                    document.getElementById('user-id').textContent = userData.id
                    document.getElementById('user-name').textContent = userData.username
                    document.getElementById('user-points').textContent = userData.points
                    document.getElementById('user-info').classList.remove('hidden')
                } else {
                    resultDiv.innerHTML = `<span class="error">è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${response.status}</span>`
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${error.message}</span>`
            }
        }

        // æµ‹è¯•æ£€æŸ¥ç§¯åˆ†
        async function testCheckPoints() {
            const resultDiv = document.getElementById('points-result')
            resultDiv.classList.remove('hidden')
            
            try {
                const response = await fetch('/auth/check-points', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await supabaseClient.auth.getSession().then(s => s.data.session?.access_token)}`
                    },
                    body: JSON.stringify({ requiredPoints: 10 })
                })

                if (response.ok) {
                    const data = await response.json()
                    resultDiv.innerHTML = `<span class="success">âœ… æ£€æŸ¥ç§¯åˆ†æˆåŠŸ: å½“å‰${data.currentPoints}ç§¯åˆ†ï¼Œéœ€è¦${data.requiredPoints}ç§¯åˆ†ï¼Œ${data.hasEnough ? 'è¶³å¤Ÿ' : 'ä¸è¶³'}</span>`
                } else {
                    resultDiv.innerHTML = `<span class="error">æ£€æŸ¥ç§¯åˆ†å¤±è´¥: ${response.status}</span>`
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">æ£€æŸ¥ç§¯åˆ†å¤±è´¥: ${error.message}</span>`
            }
        }

        // æµ‹è¯•æ¶ˆè´¹ç§¯åˆ†
        async function testConsumePoints() {
            const resultDiv = document.getElementById('points-result')
            resultDiv.classList.remove('hidden')
            
            try {
                const response = await fetch('/auth/consume-points', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await supabaseClient.auth.getSession().then(s => s.data.session?.access_token)}`
                    },
                    body: JSON.stringify({ points: 10 })
                })

                if (response.ok) {
                    const data = await response.json()
                    resultDiv.innerHTML = `<span class="success">âœ… æ¶ˆè´¹ç§¯åˆ†æˆåŠŸ: æ¶ˆè´¹${data.consumedPoints}ç§¯åˆ†ï¼Œå‰©ä½™${data.newPoints}ç§¯åˆ†</span>`
                } else {
                    const errorData = await response.json()
                    resultDiv.innerHTML = `<span class="error">æ¶ˆè´¹ç§¯åˆ†å¤±è´¥: ${errorData.error}</span>`
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">æ¶ˆè´¹ç§¯åˆ†å¤±è´¥: ${error.message}</span>`
            }
        }

        // æµ‹è¯•å¥–åŠ±ç§¯åˆ†
        async function testRewardPoints() {
            const resultDiv = document.getElementById('points-result')
            resultDiv.classList.remove('hidden')
            
            try {
                const response = await fetch('/auth/reward-points', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await supabaseClient.auth.getSession().then(s => s.data.session?.access_token)}`
                    },
                    body: JSON.stringify({ points: 5 })
                })

                if (response.ok) {
                    const data = await response.json()
                    resultDiv.innerHTML = `<span class="success">âœ… å¥–åŠ±ç§¯åˆ†æˆåŠŸ: å¥–åŠ±${data.rewardedPoints}ç§¯åˆ†ï¼Œæ€»è®¡${data.newPoints}ç§¯åˆ†</span>`
                } else {
                    resultDiv.innerHTML = `<span class="error">å¥–åŠ±ç§¯åˆ†å¤±è´¥: ${response.status}</span>`
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">å¥–åŠ±ç§¯åˆ†å¤±è´¥: ${error.message}</span>`
            }
        }

        // æµ‹è¯•åç«¯API
        async function testBackendAPI() {
            const resultDiv = document.getElementById('api-result')
            resultDiv.classList.remove('hidden')
            
            try {
                resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•åç«¯è¿æ¥...'
                
                const response = await fetch('/jobs/test')
                
                if (response.status === 404) {
                    resultDiv.innerHTML = `<span class="success">âœ… åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ (404 æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸º /jobs/test ä¸å­˜åœ¨)</span>`
                } else {
                    resultDiv.innerHTML = `<span class="success">âœ… åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ (çŠ¶æ€ç : ${response.status})</span>`
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">åç«¯è¿æ¥å¤±è´¥: ${error.message}</span>`
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { user } } = await supabaseClient.auth.getUser()
            if (user) {
                currentUser = user
                await getUserInfo()
            }
        })
    </script>
</body>
</html>
