<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>认证系统测试</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 2rem;
            margin: 1rem 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #333;
            margin-bottom: 1rem;
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 14px;
        }
        .test-button:hover {
            background: #5a6fd8;
        }
        .test-result {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            color: #27ae60;
        }
        .error {
            color: #e74c3c;
        }
        .user-info {
            background: #e8f4fd;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>🧪 Supabase 认证系统测试</h1>
    
    <!-- 配置测试 -->
    <div class="test-section">
        <h2>1. 配置测试</h2>
        <button class="test-button" onclick="testConfig()">测试 Supabase 连接</button>
        <div id="config-result" class="test-result hidden"></div>
    </div>

    <!-- 认证测试 -->
    <div class="test-section">
        <h2>2. 认证测试</h2>
        <div>
            <input type="text" id="testUsername" placeholder="测试用户名" value="testuser">
            <input type="password" id="testPassword" placeholder="测试密码" value="123456">
        </div>
        <button class="test-button" onclick="testRegister()">测试注册</button>
        <button class="test-button" onclick="testLogin()">测试登录</button>
        <button class="test-button" onclick="testLogout()">测试退出</button>
        <div id="auth-result" class="test-result hidden"></div>
    </div>

    <!-- 用户信息 -->
    <div class="test-section">
        <h2>3. 用户信息</h2>
        <div id="user-info" class="user-info hidden">
            <p><strong>用户ID:</strong> <span id="user-id"></span></p>
            <p><strong>用户名:</strong> <span id="user-name"></span></p>
            <p><strong>积分:</strong> <span id="user-points"></span></p>
        </div>
        <button class="test-button" onclick="getUserInfo()">获取用户信息</button>
        <div id="user-result" class="test-result hidden"></div>
    </div>

    <!-- 积分测试 -->
    <div class="test-section">
        <h2>4. 积分系统测试</h2>
        <button class="test-button" onclick="testCheckPoints()">检查积分</button>
        <button class="test-button" onclick="testConsumePoints()">消费积分 (10)</button>
        <button class="test-button" onclick="testRewardPoints()">奖励积分 (5)</button>
        <div id="points-result" class="test-result hidden"></div>
    </div>

    <!-- API 测试 -->
    <div class="test-section">
        <h2>5. 后端 API 测试</h2>
        <button class="test-button" onclick="testBackendAPI()">测试后端连接</button>
        <div id="api-result" class="test-result hidden"></div>
    </div>

    <script>
        // Supabase配置
        const SUPABASE_URL = 'https://bqbtkaljxsmdcpedrerg.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxYnRrYWxqeHNtZGNwZWRyZXJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NDg0NDUsImV4cCI6MjA3NDAyNDQ0NX0._XIcJcSg_00b_iOs90QM5GNaKAg5_LEHGDrexDTFcMQ'
        
        const { createClient } = supabase
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY)

        let currentUser = null

        // 测试配置
        async function testConfig() {
            const resultDiv = document.getElementById('config-result')
            resultDiv.classList.remove('hidden')
            
            try {
                resultDiv.textContent = '正在测试 Supabase 连接...'
                
                // 测试连接
                const { data, error } = await supabaseClient.auth.getSession()
                
                if (error) {
                    resultDiv.innerHTML = `<span class="error">连接失败: ${error.message}</span>`
                } else {
                    resultDiv.innerHTML = `<span class="success">✅ Supabase 连接成功！</span>`
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">连接失败: ${error.message}</span>`
            }
        }

        // 测试注册
        async function testRegister() {
            const resultDiv = document.getElementById('auth-result')
            resultDiv.classList.remove('hidden')
            
            const username = document.getElementById('testUsername').value
            const password = document.getElementById('testPassword').value
            
            try {
                resultDiv.textContent = '正在注册...'
                
                const { data, error } = await supabaseClient.auth.signUp({
                    email: `${username}@temp.com`,
                    password: password,
                    options: {
                        data: { username: username }
                    }
                })
                
                if (error) {
                    resultDiv.innerHTML = `<span class="error">注册失败: ${error.message}</span>`
                } else {
                    resultDiv.innerHTML = `<span class="success">✅ 注册成功！用户ID: ${data.user?.id}</span>`
                    currentUser = data.user
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">注册失败: ${error.message}</span>`
            }
        }

        // 测试登录
        async function testLogin() {
            const resultDiv = document.getElementById('auth-result')
            resultDiv.classList.remove('hidden')
            
            const username = document.getElementById('testUsername').value
            const password = document.getElementById('testPassword').value
            
            try {
                resultDiv.textContent = '正在登录...'
                
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: `${username}@temp.com`,
                    password: password
                })
                
                if (error) {
                    resultDiv.innerHTML = `<span class="error">登录失败: ${error.message}</span>`
                } else {
                    resultDiv.innerHTML = `<span class="success">✅ 登录成功！</span>`
                    currentUser = data.user
                    await getUserInfo()
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">登录失败: ${error.message}</span>`
            }
        }

        // 测试退出
        async function testLogout() {
            const resultDiv = document.getElementById('auth-result')
            resultDiv.classList.remove('hidden')
            
            try {
                await supabaseClient.auth.signOut()
                resultDiv.innerHTML = `<span class="success">✅ 退出成功！</span>`
                currentUser = null
                document.getElementById('user-info').classList.add('hidden')
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">退出失败: ${error.message}</span>`
            }
        }

        // 获取用户信息
        async function getUserInfo() {
            const resultDiv = document.getElementById('user-result')
            resultDiv.classList.remove('hidden')
            
            try {
                const { data: { user } } = await supabaseClient.auth.getUser()
                
                if (!user) {
                    resultDiv.innerHTML = `<span class="error">未登录</span>`
                    document.getElementById('user-info').classList.add('hidden')
                    return
                }

                // 调用后端API获取用户信息
                const response = await fetch('/auth/user', {
                    headers: {
                        'Authorization': `Bearer ${await supabaseClient.auth.getSession().then(s => s.data.session?.access_token)}`
                    }
                })

                if (response.ok) {
                    const userData = await response.json()
                    resultDiv.innerHTML = `<span class="success">✅ 获取用户信息成功</span>`
                    
                    // 显示用户信息
                    document.getElementById('user-id').textContent = userData.id
                    document.getElementById('user-name').textContent = userData.username
                    document.getElementById('user-points').textContent = userData.points
                    document.getElementById('user-info').classList.remove('hidden')
                } else {
                    resultDiv.innerHTML = `<span class="error">获取用户信息失败: ${response.status}</span>`
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">获取用户信息失败: ${error.message}</span>`
            }
        }

        // 测试检查积分
        async function testCheckPoints() {
            const resultDiv = document.getElementById('points-result')
            resultDiv.classList.remove('hidden')
            
            try {
                const response = await fetch('/auth/check-points', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await supabaseClient.auth.getSession().then(s => s.data.session?.access_token)}`
                    },
                    body: JSON.stringify({ requiredPoints: 10 })
                })

                if (response.ok) {
                    const data = await response.json()
                    resultDiv.innerHTML = `<span class="success">✅ 检查积分成功: 当前${data.currentPoints}积分，需要${data.requiredPoints}积分，${data.hasEnough ? '足够' : '不足'}</span>`
                } else {
                    resultDiv.innerHTML = `<span class="error">检查积分失败: ${response.status}</span>`
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">检查积分失败: ${error.message}</span>`
            }
        }

        // 测试消费积分
        async function testConsumePoints() {
            const resultDiv = document.getElementById('points-result')
            resultDiv.classList.remove('hidden')
            
            try {
                const response = await fetch('/auth/consume-points', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await supabaseClient.auth.getSession().then(s => s.data.session?.access_token)}`
                    },
                    body: JSON.stringify({ points: 10 })
                })

                if (response.ok) {
                    const data = await response.json()
                    resultDiv.innerHTML = `<span class="success">✅ 消费积分成功: 消费${data.consumedPoints}积分，剩余${data.newPoints}积分</span>`
                } else {
                    const errorData = await response.json()
                    resultDiv.innerHTML = `<span class="error">消费积分失败: ${errorData.error}</span>`
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">消费积分失败: ${error.message}</span>`
            }
        }

        // 测试奖励积分
        async function testRewardPoints() {
            const resultDiv = document.getElementById('points-result')
            resultDiv.classList.remove('hidden')
            
            try {
                const response = await fetch('/auth/reward-points', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await supabaseClient.auth.getSession().then(s => s.data.session?.access_token)}`
                    },
                    body: JSON.stringify({ points: 5 })
                })

                if (response.ok) {
                    const data = await response.json()
                    resultDiv.innerHTML = `<span class="success">✅ 奖励积分成功: 奖励${data.rewardedPoints}积分，总计${data.newPoints}积分</span>`
                } else {
                    resultDiv.innerHTML = `<span class="error">奖励积分失败: ${response.status}</span>`
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">奖励积分失败: ${error.message}</span>`
            }
        }

        // 测试后端API
        async function testBackendAPI() {
            const resultDiv = document.getElementById('api-result')
            resultDiv.classList.remove('hidden')
            
            try {
                resultDiv.textContent = '正在测试后端连接...'
                
                const response = await fetch('/jobs/test')
                
                if (response.status === 404) {
                    resultDiv.innerHTML = `<span class="success">✅ 后端服务正常运行 (404 是正常的，因为 /jobs/test 不存在)</span>`
                } else {
                    resultDiv.innerHTML = `<span class="success">✅ 后端服务正常运行 (状态码: ${response.status})</span>`
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">后端连接失败: ${error.message}</span>`
            }
        }

        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { user } } = await supabaseClient.auth.getUser()
            if (user) {
                currentUser = user
                await getUserInfo()
            }
        })
    </script>
</body>
</html>
