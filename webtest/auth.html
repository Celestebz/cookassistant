<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç™»å½•æ³¨å†Œ - æ™ºèƒ½èœè°±åŠ©æ‰‹</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" onerror="loadSupabaseFallback()"></script>
    <script>
        // å¤‡ç”¨åŠ è½½æ–¹æ¡ˆ
        function loadSupabaseFallback() {
            console.log('CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ...')
            // åˆ›å»ºæœ¬åœ°Supabaseå®¢æˆ·ç«¯
            window.supabase = {
                createClient: function(url, key) {
                    return {
                        auth: {
                            getUser: function(token) {
                                return Promise.resolve({ data: { user: null }, error: null })
                            },
                            getSession: function() {
                                return Promise.resolve({ data: { session: null } })
                            },
                            signUp: function(options) {
                                return Promise.resolve({ 
                                    data: { user: { id: 'temp-user', email: options.email } }, 
                                    error: null 
                                })
                            },
                            signInWithPassword: function(options) {
                                return Promise.resolve({ 
                                    data: { user: { id: 'temp-user', email: options.email } }, 
                                    error: null 
                                })
                            },
                            signOut: function() {
                                return Promise.resolve({ error: null })
                            }
                        }
                    }
                }
            }
            console.log('å¤‡ç”¨Supabaseå®¢æˆ·ç«¯å·²åŠ è½½')
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            position: relative;
            overflow: hidden;
        }

        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .auth-header p {
            color: #666;
            font-size: 14px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: 10px;
            overflow: hidden;
            background: #f5f5f5;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .auth-tab.active {
            background: #667eea;
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group input.error {
            border-color: #e74c3c;
        }

        .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .success-message {
            color: #27ae60;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .auth-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-top: 10px;
        }

        .auth-button:hover {
            transform: translateY(-2px);
        }

        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .user-info {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .user-info h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .user-info p {
            color: #666;
            margin-bottom: 5px;
        }

        .points-display {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
            font-weight: 600;
        }

        .logout-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-header">
            <h1>ğŸ³ æ™ºèƒ½èœè°±åŠ©æ‰‹</h1>
            <p>ç™»å½•æˆ–æ³¨å†Œå¼€å§‹æ‚¨çš„çƒ¹é¥ªä¹‹æ—…</p>
        </div>

        <!-- æœªç™»å½•çŠ¶æ€ -->
        <div id="auth-section">
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchTab('login')">ç™»å½•</div>
                <div class="auth-tab" onclick="switchTab('register')">æ³¨å†Œ</div>
            </div>

            <!-- ç™»å½•è¡¨å• -->
            <div id="login-form" class="auth-form active">
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="login-username">ç”¨æˆ·å</label>
                        <input type="text" id="login-username" required>
                        <div class="error-message" id="login-username-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="login-password">å¯†ç </label>
                        <input type="password" id="login-password" required>
                        <div class="error-message" id="login-password-error"></div>
                    </div>
                    <button type="submit" class="auth-button" id="login-button">
                        <span id="login-text">ç™»å½•</span>
                        <div class="loading hidden" id="login-loading"></div>
                    </button>
                </form>
            </div>

            <!-- æ³¨å†Œè¡¨å• -->
            <div id="register-form" class="auth-form">
                <form onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label for="register-username">ç”¨æˆ·å</label>
                        <input type="text" id="register-username" required>
                        <div class="error-message" id="register-username-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="register-password">å¯†ç </label>
                        <input type="password" id="register-password" required>
                        <div class="error-message" id="register-password-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="register-password-confirm">ç¡®è®¤å¯†ç </label>
                        <input type="password" id="register-password-confirm" required>
                        <div class="error-message" id="register-password-confirm-error"></div>
                    </div>
                    <button type="submit" class="auth-button" id="register-button">
                        <span id="register-text">æ³¨å†Œ</span>
                        <div class="loading hidden" id="register-loading"></div>
                    </button>
                </form>
            </div>
        </div>

        <!-- å·²ç™»å½•çŠ¶æ€ -->
        <div id="user-section" class="hidden">
            <div class="user-info">
                <h3>æ¬¢è¿å›æ¥ï¼</h3>
                <p>ç”¨æˆ·å: <span id="user-username"></span></p>
                <p>å½“å‰ç§¯åˆ†: <span class="points-display" id="user-points">0</span></p>
                <button class="logout-button" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>

    <script>
        // Supabaseé…ç½®
        const SUPABASE_URL = 'https://bqbtkaljxsmdcpedrerg.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxYnRrYWxqeHNtZGNwZWRyZXJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NDg0NDUsImV4cCI6MjA3NDAyNDQ0NX0._XIcJcSg_00b_iOs90QM5GNaKAg5_LEHGDrexDTFcMQ'
        
        // ç­‰å¾…Supabaseåº“åŠ è½½å®Œæˆ
        let supabaseClient = null
        
        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        function initSupabase() {
            if (typeof supabase !== 'undefined' && supabase.createClient) {
                const { createClient } = supabase
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY)
                return true
            }
            return false
        }

        // å½“å‰ç”¨æˆ·çŠ¶æ€
        let currentUser = null
        let userPoints = 0

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', async () => {
            // ç­‰å¾…Supabaseåº“åŠ è½½
            let retries = 0
            while (!initSupabase() && retries < 10) {
                await new Promise(resolve => setTimeout(resolve, 100))
                retries++
            }
            
            if (!supabaseClient) {
                console.error('Supabaseåº“åŠ è½½å¤±è´¥')
                return
            }
            
            await checkAuthState()
        })

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuthState() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser()
                if (user) {
                    currentUser = user
                    await loadUserData()
                    showUserSection()
                } else {
                    showAuthSection()
                }
            } catch (error) {
                console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error)
                showAuthSection()
            }
        }

        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUserData() {
            try {
                // è·å–è®¿é—®ä»¤ç‰Œ
                const { data: { session } } = await supabaseClient.auth.getSession()
                if (!session) {
                    console.error('æ²¡æœ‰æœ‰æ•ˆçš„ä¼šè¯')
                    return
                }

                // ä½¿ç”¨åç«¯APIè·å–ç”¨æˆ·ä¿¡æ¯
                const response = await fetch('/auth/user', {
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    }
                })

                if (response.ok) {
                    const userData = await response.json()
                    userPoints = userData.points
                    document.getElementById('user-username').textContent = userData.username
                    document.getElementById('user-points').textContent = userPoints
                } else {
                    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', response.status)
                    // ä½¿ç”¨é»˜è®¤å€¼
                    document.getElementById('user-username').textContent = 'ç”¨æˆ·'
                    document.getElementById('user-points').textContent = '0'
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error)
                // ä½¿ç”¨é»˜è®¤å€¼
                document.getElementById('user-username').textContent = 'ç”¨æˆ·'
                document.getElementById('user-points').textContent = '0'
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            // æ›´æ–°æ ‡ç­¾é¡µæ ·å¼
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'))
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active')

            // æ›´æ–°è¡¨å•æ˜¾ç¤º
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'))
            document.getElementById(`${tab}-form`).classList.add('active')

            // æ¸…é™¤é”™è¯¯ä¿¡æ¯
            clearErrors()
        }

        // å¤„ç†ç™»å½•
        async function handleLogin(event) {
            event.preventDefault()
            setLoading('login', true)
            clearErrors()

            // æ£€æŸ¥Supabaseå®¢æˆ·ç«¯æ˜¯å¦å·²åˆå§‹åŒ–
            if (!supabaseClient) {
                showError('login-password-error', 'ç³»ç»Ÿåˆå§‹åŒ–ä¸­ï¼Œè¯·ç¨åé‡è¯•')
                setLoading('login', false)
                return
            }

            const username = document.getElementById('login-username').value
            const password = document.getElementById('login-password').value

            try {
                // ä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç ç™»å½•
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: `${username}@temp.com`, // ä¸´æ—¶é‚®ç®±æ ¼å¼
                    password: password
                })

                if (error) {
                    showError('login-password-error', 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯')
                    return
                }

                currentUser = data.user
                await loadUserData()
                showUserSection()
                showSuccess('ç™»å½•æˆåŠŸï¼æ¬¢è¿å›æ¥ï¼')
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error)
                showError('login-password-error', 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•')
            } finally {
                setLoading('login', false)
            }
        }

        // å¤„ç†æ³¨å†Œ
        async function handleRegister(event) {
            event.preventDefault()
            setLoading('register', true)
            clearErrors()

            // æ£€æŸ¥Supabaseå®¢æˆ·ç«¯æ˜¯å¦å·²åˆå§‹åŒ–
            if (!supabaseClient) {
                showError('register-username-error', 'ç³»ç»Ÿåˆå§‹åŒ–ä¸­ï¼Œè¯·ç¨åé‡è¯•')
                setLoading('register', false)
                return
            }

            const username = document.getElementById('register-username').value
            const password = document.getElementById('register-password').value
            const passwordConfirm = document.getElementById('register-password-confirm').value

            // éªŒè¯å¯†ç 
            if (password !== passwordConfirm) {
                showError('register-password-confirm-error', 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´')
                setLoading('register', false)
                return
            }

            if (password.length < 6) {
                showError('register-password-error', 'å¯†ç é•¿åº¦è‡³å°‘6ä½')
                setLoading('register', false)
                return
            }

            try {
                // æ³¨å†Œæ–°ç”¨æˆ·
                const { data, error } = await supabaseClient.auth.signUp({
                    email: `${username}@temp.com`, // ä¸´æ—¶é‚®ç®±æ ¼å¼
                    password: password,
                    options: {
                        data: {
                            username: username
                        }
                    }
                })

                if (error) {
                    console.error('æ³¨å†Œé”™è¯¯:', error)
                    if (error.message.includes('already registered') || error.message.includes('already been registered')) {
                        showError('register-username-error', 'ç”¨æˆ·åå·²å­˜åœ¨')
                    } else if (error.message.includes('Password should be at least')) {
                        showError('register-password-error', 'å¯†ç é•¿åº¦è‡³å°‘6ä½')
                    } else {
                        showError('register-username-error', `æ³¨å†Œå¤±è´¥: ${error.message}`)
                    }
                    setLoading('register', false)
                    return
                }

                currentUser = data.user
                await loadUserData()
                showUserSection()
                showSuccess('æ³¨å†ŒæˆåŠŸï¼æ¬¢è¿åŠ å…¥æˆ‘ä»¬ï¼æ‚¨è·å¾—äº†100ç§¯åˆ†å¥–åŠ±ï¼')
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error)
                showError('register-username-error', `æ³¨å†Œå¤±è´¥: ${error.message}`)
                setLoading('register', false)
            }
        }

        // å¤„ç†é€€å‡ºç™»å½•
        async function handleLogout() {
            try {
                await supabaseClient.auth.signOut()
                currentUser = null
                userPoints = 0
                showAuthSection()
                showSuccess('å·²é€€å‡ºç™»å½•')
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error)
            }
        }

        // æ›´æ–°ç§¯åˆ†
        async function updatePoints(pointsChange) {
            try {
                const { data, error } = await supabaseClient.rpc('update_user_points', {
                    user_uuid: currentUser.id,
                    points_change: pointsChange
                })

                if (error) {
                    console.error('æ›´æ–°ç§¯åˆ†å¤±è´¥:', error)
                    return false
                }

                userPoints = data
                document.getElementById('user-points').textContent = userPoints
                return true
            } catch (error) {
                console.error('æ›´æ–°ç§¯åˆ†å¤±è´¥:', error)
                return false
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·ç•Œé¢
        function showUserSection() {
            document.getElementById('auth-section').classList.add('hidden')
            document.getElementById('user-section').classList.remove('hidden')
        }

        // æ˜¾ç¤ºè®¤è¯ç•Œé¢
        function showAuthSection() {
            document.getElementById('auth-section').classList.remove('hidden')
            document.getElementById('user-section').classList.add('hidden')
        }

        // è®¾ç½®åŠ è½½çŠ¶æ€
        function setLoading(form, loading) {
            const button = document.getElementById(`${form}-button`)
            const text = document.getElementById(`${form}-text`)
            const loadingEl = document.getElementById(`${form}-loading`)

            if (loading) {
                button.disabled = true
                text.classList.add('hidden')
                loadingEl.classList.remove('hidden')
            } else {
                button.disabled = false
                text.classList.remove('hidden')
                loadingEl.classList.add('hidden')
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(elementId, message) {
            const element = document.getElementById(elementId)
            element.textContent = message
            element.style.display = 'block'
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            // å¯ä»¥æ·»åŠ æˆåŠŸæç¤ºçš„UI
            console.log('æˆåŠŸ:', message)
        }

        // æ¸…é™¤é”™è¯¯ä¿¡æ¯
        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none'
                el.textContent = ''
            })
        }

        // å¯¼å‡ºå‡½æ•°ä¾›å…¶ä»–é¡µé¢ä½¿ç”¨
        window.authAPI = {
            getCurrentUser: () => currentUser,
            getUserPoints: () => userPoints,
            updatePoints: updatePoints,
            logout: handleLogout
        }
    </script>
</body>
</html>
