<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能烹饪助手 - 图片转菜谱</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js" onerror="console.warn('Iconify加载失败，但不影响核心功能')"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js" onerror="console.warn('ECharts加载失败，但不影响核心功能')"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 1440px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-radius: 16px;
            overflow: hidden;
            min-height: 100vh;
        }
        
        .upload-zone {
            background: linear-gradient(to right, #ffefe3, #fff3d9);
            border: 3px dashed #ffa726;
            transition: all 0.3s ease;
        }
        
        .upload-zone.drag-over {
            background: linear-gradient(to right, #ffebd6, #ffeec9);
            border: 3px dashed #ff9800;
            transform: scale(1.02);
        }
        
        .progress-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #4caf50, #8bc34a);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .ingredient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .recipe-step:hover {
            border-left: 4px solid #ff9800;
        }
        
        .nutri-chart {
            height: 300px;
            width: 100%;
        }
        
        /* Custom animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
            opacity: 1 !important;
            display: block !important;
            visibility: visible !important;
        }
        
        #resultsSection {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        #resultsSection.hidden {
            display: none !important;
        }
        
        /* Smooth transition for ingredients and recipes */
        .transition-section {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        opacity 0.3s ease;
        }
        
        /* Custom button effects */
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.35);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.35);
        }
        
        /* Responsive handling */
        @media (max-width: 768px) {
            .flex-col-reverse-medium {
                flex-direction: column-reverse;
            }
        }
        
        .hidden { display: none; }
    </style>
  </head>
  <body>
    <div class="container">
        <!-- 顶部导航 -->
        <header class="bg-white py-4 px-8 flex items-center justify-between border-b border-gray-100">
            <div class="flex items-center space-x-2">
                <div class="bg-orange-500 p-2 rounded-lg">
                    <iconify-icon icon="mdi:chef-hat" style="color: white;" width="32" height="32"></iconify-icon>
                </div>
                <h1 class="text-2xl font-black text-gray-800">美味助手</h1>
            </div>
            
            <nav>
                <ul class="flex space-x-6 font-medium">
                    <li><a href="#" class="text-orange-500 hover:text-orange-600">首页</a></li>
                    <li><a href="#" class="text-gray-700 hover:text-orange-500">菜单推荐</a></li>
                    <li><a href="#" class="text-gray-700 hover:text-orange-500">食材百科</a></li>
                    <li><a href="#" class="text-gray-700 hover:text-orange-500">我的收藏</a></li>
                </ul>
            </nav>
            
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <iconify-icon icon="mdi:bell-outline" class="text-gray-600" width="24" height="24"></iconify-icon>
                    <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
                </div>
                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                    <iconify-icon icon="mdi:user" class="text-green-600" width="24" height="24"></iconify-icon>
                </div>
            </div>
        </header>

        <!-- 主内容区 -->
        <main>
            <!-- 图片上传区 -->
            <section class="py-12 px-16">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">智能识图烹饪助手</h2>
                <p class="text-gray-600 mb-8 max-w-3xl">上传您的美食图片，自动生成菜谱与食材清单</p>
                
                <div class="upload-zone rounded-2xl p-10 mb-8 flex flex-col items-center justify-center cursor-pointer" id="uploadZone">
                    <iconify-icon icon="mdi:cloud-upload-outline" class="text-orange-500 mb-4" width="64" height="64"></iconify-icon>
                    <p class="text-xl font-medium text-gray-700 mb-2">拖放您的食物图片到这里</p>
                    <p class="text-gray-500 mb-6">支持 JPG、PNG 等格式，最大 10MB</p>
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                    <button id="uploadBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-8 rounded-full transition-all duration-300 btn-primary">
                        选择图片
                    </button>
                    <div id="uploadStatus" class="mt-4 text-sm text-gray-500 hidden">
                        点击按钮选择图片文件
                    </div>
                    <div id="error" class="mt-2 text-sm text-red-500 hidden">
                        错误信息将显示在这里
                    </div>
                </div>
                
                <!-- 状态标签 -->
                <div id="chips" class="text-center mt-4"></div>
                
                <div id="progressSection" class="px-4 hidden">
                    <div class="progress-bar mb-3">
                        <div id="progressFill" class="progress-fill w-0"></div>
                    </div>
                    <p id="progressText" class="text-sm text-gray-500 text-right">分析中: 0%</p>
                </div>
            </section>
            
            <!-- 食材与菜谱结果区 -->
            <section id="resultsSection" class="transition-section px-16 mb-16 hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                    <!-- 左侧食材区域 -->
                    <div class="bg-green-50 p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">食材清单</h3>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                                    识别准确率: 92%
                                </span>
                            </div>
                        </div>
                        
                        <div id="ingredientsList" class="space-y-3">
                            <!-- 动态生成的食材列表 -->
                        </div>
                        
                        <button class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg mt-6 transition-all">
                            生成购物清单
                        </button>
                    </div>
                    
                    <!-- 右侧菜谱区域 -->
                    <div class="lg:col-span-2 bg-orange-50 p-6 rounded-2xl">
                        <div class="flex justify-between items-start mb-6">
                            <h3 id="recipeTitle" class="text-2xl font-bold text-gray-800">推荐菜谱</h3>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-sm font-medium">
                                    烹饪时间: 45分钟
                                </span>
                                <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-sm font-medium">
                                    难度: 中等
                                </span>
                            </div>
                        </div>
                        
                        <div class="mb-8 rounded-xl overflow-hidden bg-gray-50 flex items-center justify-center" style="min-height: 300px; max-height: 500px;">
                            <img id="flatlayImage" src="" alt="上传的原始图片" class="max-w-full max-h-full object-contain hidden">
                        </div>
                        
                        <div id="recipeSteps" class="space-y-6">
                            <!-- 动态生成的菜谱步骤 -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- 食材可视化区域 -->
            <section id="nutritionSection" class="transition-section opacity-0 transform translate-y-8 px-16 mb-16 hidden">
                <div class="bg-gray-50 p-8 rounded-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">食材营养成分分析</h3>
                        <div class="flex space-x-3">
                            <button class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-100">
                                热量分析
                            </button>
                            <button class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-100">
                                营养均衡
                            </button>
                            <button class="px-4 py-2 bg-orange-500 text-white border border-orange-500 rounded-lg font-medium">
                                用量比例
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-2xl shadow-sm">
                            <h4 class="font-medium text-gray-700 mb-4">食材用量占比</h4>
                            <div class="nutri-chart" id="chart-ingredient-ratio"></div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-2xl shadow-sm">
                            <h4 class="font-medium text-gray-700 mb-4">营养成分构成</h4>
                            <div class="nutri-chart" id="chart-nutrition"></div>
                        </div>
                    </div>
                    
                    <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-5 rounded-xl shadow-sm">
                            <div class="flex items-center mb-3">
                                <div class="w-4 h-4 bg-red-500 rounded-full mr-2"></div>
                                <div class="font-medium text-gray-800">热量</div>
                            </div>
                            <div class="text-2xl font-bold text-red-600">420 kcal</div>
                            <div class="text-sm text-gray-500 mt-1">约成年人每日需要的17%</div>
                        </div>
                        
                        <div class="bg-white p-5 rounded-xl shadow-sm">
                            <div class="flex items-center mb-3">
                                <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                                <div class="font-medium text-gray-800">蛋白质</div>
                            </div>
                            <div class="text-2xl font-bold text-green-600">35g</div>
                            <div class="text-sm text-gray-500 mt-1">优质动物蛋白比例高</div>
                        </div>
                        
                        <div class="bg-white p-5 rounded-xl shadow-sm">
                            <div class="flex items-center mb-3">
                                <div class="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
                                <div class="font-medium text-gray-800">膳食纤维</div>
                            </div>
                            <div class="text-2xl font-bold text-blue-600">7.2g</div>
                            <div class="text-sm text-gray-500 mt-1">主要来源于根茎类蔬菜</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- 操作功能区 -->
            <section id="actionSection" class="transition-section opacity-0 transform translate-y-8 px-16 mb-16 hidden">
                <div class="bg-white p-8 rounded-2xl border border-gray-100 shadow-sm">
                    <div class="flex items-center justify-between flex-wrap gap-4">
      <div>
                            <h3 class="text-xl font-bold text-gray-800">完成分析, 下一步操作</h3>
                            <p class="text-gray-500">保存、分享或打印您的个性化菜谱</p>
                        </div>
                        
                        <div class="flex space-x-4 flex-wrap">
                            <button id="copyStepsBtn" class="flex items-center bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-6 rounded-lg transition-all btn-primary">
                                <iconify-icon icon="mdi:bookmark-outline" class="text-lg mr-2"></iconify-icon>
                                复制菜谱
                            </button>
                            
                            <button id="feedbackUpBtn" class="flex items-center bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-6 rounded-lg transition-all">
                                <iconify-icon icon="mdi:thumb-up" class="text-lg mr-2"></iconify-icon>
                                准确
                            </button>
                            
                            <button id="feedbackDownBtn" class="flex items-center bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-6 rounded-lg transition-all btn-danger">
                                <iconify-icon icon="mdi:thumb-down" class="text-lg mr-2"></iconify-icon>
                                不准确
                            </button>
                        </div>
      </div>

                    <div class="mt-8 pt-6 border-t border-gray-100">
                        <div class="flex space-x-4">
                            <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg">
                                调整为1人份
                            </button>
                            <button class="px-4 py-2 bg-orange-500 text-white rounded-lg">
                                2人份
                            </button>
                            <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg">
                                3人份
                            </button>
                            <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg">
                                4人份
                            </button>
                            <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg flex items-center">
                                单位 <iconify-icon icon="mdi:chevron-down" class="ml-1"></iconify-icon>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        
        <!-- 页脚区 -->
        <footer class="bg-gray-800 text-gray-300 py-10 px-16">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <div class="flex items-center mb-4">
                        <div class="bg-orange-500 p-2 rounded-lg">
                            <iconify-icon icon="mdi:chef-hat" style="color: white;" width="28" height="28"></iconify-icon>
                        </div>
                        <h3 class="text-white text-xl font-bold ml-2">美味助手</h3>
        </div>
                    <p class="mb-4 text-gray-400">
                        用科技让烹饪更简单，让美味没有门槛
                    </p>
                    <div class="flex space-x-3">
                        <a href="#" class="text-gray-400 hover:text-white"><iconify-icon icon="mdi:wechat" width="22"></iconify-icon></a>
                        <a href="#" class="text-gray-400 hover:text-white"><iconify-icon icon="mdi:weibo" width="22"></iconify-icon></a>
                        <a href="#" class="text-gray-400 hover:text-white"><iconify-icon icon="mdi:instagram" width="22"></iconify-icon></a>
        </div>
      </div>

                <div>
                    <h4 class="text-white font-medium mb-4">关于我们</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="hover:text-white">品牌故事</a></li>
                        <li><a href="#" class="hover:text-white">团队介绍</a></li>
                        <li><a href="#" class="hover:text-white">加入我们</a></li>
                        <li><a href="#" class="hover:text-white">用户协议</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="text-white font-medium mb-4">帮助中心</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="hover:text-white">使用指南</a></li>
                        <li><a href="#" class="hover:text-white">常见问题</a></li>
                        <li><a href="#" class="hover:text-white">隐私政策</a></li>
                        <li><a href="#" class="hover:text-white">联系客服</a></li>
                    </ul>
      </div>

                <div>
                    <h4 class="text-white font-medium mb-4">订阅更新</h4>
                    <p class="mb-4">获取最新食谱和烹饪技巧</p>
                    <div class="flex">
                        <input type="email" placeholder="您的邮箱地址" class="px-4 py-2 bg-gray-700 text-white rounded-l-lg w-full focus:outline-none">
                        <button class="bg-orange-500 text-white px-4 rounded-r-lg">订阅</button>
                    </div>
      </div>
            </div>
            
            <div class="mt-10 pt-6 border-t border-gray-700 text-center text-gray-500 text-sm">
                <p>© 2025 美味助手智能烹饪平台 版权所有</p>
                <p class="mt-2">让每个人都能成为厨房艺术家</p>
            </div>
        </footer>
    </div>

    <script>
        // 忽略外部SDK加载错误
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('growthbook')) {
                console.warn('忽略外部SDK错误:', e.message);
                e.preventDefault();
                return false;
            }
        });
        
        const API = (path) => `http://localhost:8787${path}`;
      const el = (id) => document.getElementById(id);
      let currentJobId = null;

      function setStatus(t) { 
        const statusEl = el('uploadStatus');
        if (statusEl) {
          statusEl.textContent = t || ''; 
          statusEl.style.color = '#666';
          statusEl.classList.remove('hidden');
        }
      }
      
      function setError(t) { 
        const errorEl = el('error');
        if (errorEl) {
          errorEl.textContent = t || ''; 
          errorEl.style.color = '#dc2626';
          errorEl.classList.remove('hidden');
        }
      }
      
      function addChip(text, status = '') {
        const c = document.createElement('span');
        c.className = `status-chip status-${status || text}`;
        c.textContent = text;
        el('chips').appendChild(c);
      }
      
      function clearChips() { 
        el('chips').innerHTML = ''; 
      }

      function updateProgress(percent, text) {
        el('progressFill').style.width = `${percent}%`;
        el('progressText').textContent = text;
      }

      function showResults() {
        console.log('开始显示结果区域...');
        const resultsEl = el('resultsSection');
        if (resultsEl) {
          console.log('找到resultsSection元素');
          console.log('当前类列表:', resultsEl.classList.toString());
          
          // 移除所有隐藏类
          resultsEl.classList.remove('hidden');
          resultsEl.classList.remove('opacity-0', 'transform', 'translate-y-8');
          
          // 强制显示样式
          resultsEl.style.display = 'block';
          resultsEl.style.visibility = 'visible';
          resultsEl.style.opacity = '1';
          resultsEl.style.transform = 'none';
          resultsEl.style.position = 'relative';
          resultsEl.style.zIndex = '10';
          
          // 添加动画类
          resultsEl.classList.add('animate-fade-in');
          
          console.log('结果显示区域已显示');
          console.log('更新后类列表:', resultsEl.classList.toString());
          console.log('计算样式:', window.getComputedStyle(resultsEl).display);
          console.log('强制显示样式已应用');
          
          // 验证内容是否存在
          const titleEl = el('recipeTitle');
          const ingredientsEl = el('ingredientsList');
          const stepsEl = el('recipeSteps');
          console.log('标题元素:', titleEl ? '存在' : '不存在');
          console.log('食材容器:', ingredientsEl ? '存在' : '不存在');
          console.log('步骤容器:', stepsEl ? '存在' : '不存在');
        } else {
          console.error('找不到resultsSection元素');
        }
      }

      function displayIngredients(ingredients) {
        const container = el('ingredientsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (!ingredients || ingredients.length === 0) {
          container.innerHTML = '<div class="text-center text-gray-500 py-4">暂无食材信息</div>';
          return;
        }

        ingredients.forEach(ingredient => {
          const ingredientEl = document.createElement('div');
          ingredientEl.className = 'ingredient-card bg-white p-4 rounded-xl shadow-md flex items-center transition-all';
          ingredientEl.innerHTML = `
            <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center mr-4">
              <iconify-icon icon="mdi:food" class="text-gray-500" width="24" height="24"></iconify-icon>
            </div>
            <div class="flex-1">
              <h4 class="font-bold text-gray-800">${ingredient.name}</h4>
              <p class="text-gray-500 text-sm">${ingredient.amount || '适量'}</p>
            </div>
          `;
          container.appendChild(ingredientEl);
        });
      }

      function displaySteps(steps) {
        const container = el('recipeSteps');
        container.innerHTML = '';
        
        if (!steps || steps.length === 0) {
          container.innerHTML = '<div class="text-center text-gray-500 py-8">暂无步骤信息</div>';
          return;
        }

        steps.forEach((step, index) => {
          const stepEl = document.createElement('div');
          stepEl.className = 'step-item';
          stepEl.innerHTML = `
            <div class="flex items-start">
              <div class="bg-orange-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold mr-4 flex-shrink-0">
                ${index + 1}
              </div>
              <p class="text-gray-700 leading-relaxed">${step}</p>
            </div>
          `;
          container.appendChild(stepEl);
        });
      }

      async function createJob(file) {
        const fd = new FormData();
        fd.append('image', file);
        const res = await fetch(API('/jobs'), { method: 'POST', body: fd });
        if (!res.ok) {
          if (res.status === 413) {
            throw new Error('文件太大，请选择小于10MB的图片');
          } else if (res.status === 400) {
            throw new Error('文件格式不支持，请选择JPG、PNG等图片格式');
          } else {
            throw new Error(`上传失败 (${res.status})，请重试`);
          }
        }
        return res.json();
      }
      
      async function getJob(id) {
        const res = await fetch(API(`/jobs/${id}`));
        if (!res.ok) throw new Error('查询作业失败');
        return res.json();
      }
      
      async function postFeedback(id, rating) {
        await fetch(API('/feedback'), { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify({ jobId: id, rating }) 
        });
      }

      async function pollJob(id) {
        clearChips();
        addChip('排队中', 'queued');
        const progressEl = el('progressSection');
        if (progressEl) {
          progressEl.classList.remove('hidden');
        }
        updateProgress(10, '正在创建任务...');
        
        let tries = 0;
        while (tries < 60) {
          tries++;
          const j = await getJob(id);
          clearChips();
          
          // 更新状态标签
          const statusMap = {
            'queued': '排队中',
            'processing': '处理中',
            'succeeded': '完成',
            'failed': '失败'
          };
          addChip(statusMap[j.status] || j.status, j.status);
          
          // 更新进度条
          const progress = Math.min(90, 20 + (tries / 60) * 70);
          updateProgress(progress, `分析中... ${Math.round(progress)}%`);
          
          // 显示原始图片
          if (j.inputImageUrl) {
            const imgEl = el('flatlayImage');
            if (imgEl) {
              imgEl.src = j.inputImageUrl;
              imgEl.classList.remove('hidden');
            }
          }
          
          // 显示菜品图片
          if (j.ingredientFlatlayUrl) {
            const imgEl = el('flatlayImage');
            if (imgEl) {
              imgEl.src = j.ingredientFlatlayUrl;
              imgEl.classList.remove('hidden');
            }
          }
          
          // 显示菜品名称
          if (j.recipe?.name) {
            const titleEl = el('recipeTitle');
            if (titleEl) {
              titleEl.textContent = j.recipe.name;
              console.log('菜品名称已设置:', j.recipe.name);
            }
          }
          
          // 显示食材清单
          if (j.recipe?.ingredients?.length) {
            console.log('显示食材清单:', j.recipe.ingredients);
            displayIngredients(j.recipe.ingredients);
          }
          
          // 显示烹饪步骤
          if (j.recipe?.steps?.length) {
            console.log('显示烹饪步骤:', j.recipe.steps);
            displaySteps(j.recipe.steps);
            showResults();
          }
          
          if (j.error?.message) {
            setError(j.error.message);
            updateProgress(100, '处理失败');
          }
          
          if (j.status === 'succeeded' || j.status === 'partial' || j.status === 'failed') {
            updateProgress(100, j.status === 'succeeded' ? '分析完成！' : '处理完成');
            // 如果有菜谱信息，就显示结果
            if (j.recipe?.steps?.length || j.recipe?.ingredients?.length) {
              showResults();
            }
            return j;
          }
          
          await new Promise(r => setTimeout(r, 1000));
        }
        throw new Error('轮询超时');
      }

      // 上传按钮点击事件
      el('uploadBtn').addEventListener('click', async () => {
        el('fileInput').click();
      });

      // 文件选择事件
      el('fileInput').addEventListener('change', async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        
        // 检查文件大小
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (f.size > maxSize) {
          const fileSizeMB = (f.size / (1024 * 1024)).toFixed(2);
          setError(`文件太大 (${fileSizeMB}MB)，请选择小于10MB的图片`);
          return;
        }
        
        // 检查文件类型
        if (!f.type.startsWith('image/')) {
          setError('请选择图片文件 (JPG, PNG, GIF等)');
          return;
        }
        
        try {
          setStatus('正在上传图片...');
          setError('');
          el('recipeSteps').innerHTML = '<div class="text-center text-gray-500 py-8"><iconify-icon icon="mdi:loading" class="text-4xl mb-2"></iconify-icon><p>AI正在分析图片并生成烹饪步骤...</p></div>';
          const imgEl = el('flatlayImage');
          if (imgEl) {
            imgEl.classList.add('hidden');
          }
          
          const { id } = await createJob(f);
          currentJobId = id;
          setStatus(`任务已创建，开始分析...`);
          await pollJob(id);
          setStatus('分析完成！');
        } catch (e) {
          console.error(e);
          setStatus('处理失败');
          setError(String(e?.message || e));
        }
      });

      // 拖拽上传功能
      const uploadArea = el('uploadZone');
      if (uploadArea) {
        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
          uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadArea.classList.remove('dragover');
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            el('fileInput').files = files;
            el('fileInput').dispatchEvent(new Event('change'));
          }
        });
      }

      // 复制步骤
      el('copyStepsBtn').addEventListener('click', async () => {
        const steps = Array.from(el('recipeSteps').querySelectorAll('.step-item')).map(step => 
          step.querySelector('p').textContent.trim()
        ).join('\n');
        
        if (!steps) return;
        await navigator.clipboard.writeText(steps);
        setStatus('步骤已复制到剪贴板');
      });

      // 反馈功能
      el('feedbackUpBtn').addEventListener('click', async () => {
        if (!currentJobId) return;
        await postFeedback(currentJobId, 'up');
        setStatus('感谢您的反馈：准确');
      });
      
      el('feedbackDownBtn').addEventListener('click', async () => {
        if (!currentJobId) return;
        await postFeedback(currentJobId, 'down');
        setStatus('感谢您的反馈：不准确');
      });
    </script>
  </body>
  </html>


