<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½èœè°±åŠ©æ‰‹ - æœ¬åœ°è®¤è¯</title>
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.7/dist/iconify-icon.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .points-display {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
        }

        .auth-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .main-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .upload-zone {
            border: 2px dashed #ddd;
            border-radius: 15px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-zone.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            color: #999;
            font-size: 0.9rem;
        }

        .recipe-display {
            display: none;
            margin-top: 2rem;
        }

        .recipe-title {
            font-size: 2rem;
            color: #333;
            margin-bottom: 1rem;
            text-align: center;
        }

        .recipe-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .ingredients-section, .steps-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 15px;
        }

        .section-title {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ingredient-list {
            list-style: none;
        }

        .ingredient-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        .step-list {
            list-style: none;
        }

        .step-item {
            padding: 1rem 0;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 1rem;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-text {
            flex: 1;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .loading-icon {
            font-size: 2rem;
            color: #667eea;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: #e74c3c;
            text-align: center;
            padding: 1rem;
            background: #ffeaea;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .success {
            color: #27ae60;
            text-align: center;
            padding: 1rem;
            background: #eafaf1;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .hidden {
            display: none !important;
        }

        .points-cost {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            text-align: center;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
        }

        .modal-content h2 {
            margin-bottom: 1rem;
            text-align: center;
        }

        .modal-content input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .modal-content button {
            width: 100%;
            padding: 0.75rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨ -->
    <header class="header">
        <div class="logo">ğŸ³ æ™ºèƒ½èœè°±åŠ©æ‰‹</div>
        <div class="user-info">
            <!-- æœªç™»å½•çŠ¶æ€ -->
            <div id="auth-section">
                <div class="auth-buttons">
                    <button class="btn btn-primary" onclick="showLogin()">ç™»å½•</button>
                    <button class="btn btn-secondary" onclick="showRegister()">æ³¨å†Œ</button>
                </div>
            </div>
            <!-- å·²ç™»å½•çŠ¶æ€ -->
            <div id="user-section" class="hidden">
                <div class="points-display">
                    <iconify-icon icon="mdi:star"></iconify-icon>
                    <span id="user-points">0</span> ç§¯åˆ†
                </div>
                <div>
                    <span id="user-username">ç”¨æˆ·</span>
                    <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹ -->
    <div class="container">
        <div class="main-content">
            <!-- æœªç™»å½•æç¤º -->
            <div id="login-prompt" class="error">
                <iconify-icon icon="mdi:lock"></iconify-icon>
                è¯·å…ˆç™»å½•æˆ–æ³¨å†Œä»¥ä½¿ç”¨AIèœè°±åˆ†æåŠŸèƒ½
            </div>

            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div id="upload-section" class="hidden">
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">
                        <iconify-icon icon="mdi:cloud-upload"></iconify-icon>
                    </div>
                    <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</div>
                    <div class="upload-hint">æ”¯æŒ JPGã€PNGã€WEBP æ ¼å¼ï¼Œæœ€å¤§ 10MB</div>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                
                <div class="points-cost">
                    <iconify-icon icon="mdi:information"></iconify-icon>
                    æ¯æ¬¡AIåˆ†ææ¶ˆè€— 10 ç§¯åˆ†
                </div>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loading-section" class="loading hidden">
                <div class="loading-icon">
                    <iconify-icon icon="mdi:loading"></iconify-icon>
                </div>
                <div>AIæ­£åœ¨åˆ†ææ‚¨çš„å›¾ç‰‡...</div>
            </div>

            <!-- èœè°±æ˜¾ç¤º -->
            <div id="recipe-section" class="recipe-display">
                <div class="recipe-title" id="recipeTitle"></div>
                <div class="recipe-content">
                    <div class="ingredients-section">
                        <div class="section-title">
                            <iconify-icon icon="mdi:food"></iconify-icon>
                            ä¸»è¦é£Ÿæ
                        </div>
                        <ul class="ingredient-list" id="ingredientList"></ul>
                    </div>
                    <div class="steps-section">
                        <div class="section-title">
                            <iconify-icon icon="mdi:chef-hat"></iconify-icon>
                            çƒ¹é¥ªæ­¥éª¤
                        </div>
                        <ul class="step-list" id="stepList"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="loginModal" class="modal hidden">
        <div class="modal-content">
            <h2>ç™»å½•</h2>
            <form id="loginForm">
                <input type="text" placeholder="ç”¨æˆ·å" id="loginUsername" required>
                <input type="password" placeholder="å¯†ç " id="loginPassword" required>
                <button type="submit">ç™»å½•</button>
            </form>
        </div>
    </div>

    <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
    <div id="registerModal" class="modal hidden">
        <div class="modal-content">
            <h2>æ³¨å†Œ</h2>
            <form id="registerForm">
                <input type="text" placeholder="ç”¨æˆ·å" id="registerUsername" required>
                <input type="password" placeholder="å¯†ç " id="registerPassword" required>
                <input type="password" placeholder="ç¡®è®¤å¯†ç " id="registerPasswordConfirm" required>
                <button type="submit">æ³¨å†Œ</button>
            </form>
        </div>
    </div>

    <script>
        // æœ¬åœ°ç”¨æˆ·å­˜å‚¨
        const LOCAL_STORAGE_KEY = 'cookapp_users';
        const CURRENT_USER_KEY = 'cookapp_current_user';

        // å…¨å±€å˜é‡
        let currentUser = null;
        let userPoints = 0;
        let currentJobId = null;

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯çŠ¶æ€
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuthState();
            setupEventListeners();
        });

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuthState() {
            const storedUser = localStorage.getItem(CURRENT_USER_KEY);
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    console.log('é¡µé¢åŠ è½½ - å­˜å‚¨çš„ç”¨æˆ·æ•°æ®:', currentUser);

                    // ä»ä¸»æ•°æ®åº“åŒæ­¥æœ€æ–°ç§¯åˆ†
                    const users = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
                    console.log('é¡µé¢åŠ è½½ - ä¸»æ•°æ®åº“ç”¨æˆ·:', Object.keys(users));

                    if (users[currentUser.username]) {
                        const mainDbPoints = users[currentUser.username].points || 0;
                        console.log('é¡µé¢åŠ è½½ - ä¸»æ•°æ®åº“ç§¯åˆ†:', mainDbPoints);

                        // æ¯”è¾ƒç§¯åˆ†
                        const storedPoints = currentUser.points || 0;
                        console.log('é¡µé¢åŠ è½½ - å­˜å‚¨çš„ç§¯åˆ†:', storedPoints);

                        if (mainDbPoints !== storedPoints) {
                            console.log('é¡µé¢åŠ è½½ - æ£€æµ‹åˆ°ç§¯åˆ†å·®å¼‚ï¼ŒåŒæ­¥ä¸»æ•°æ®åº“ç§¯åˆ†');
                            userPoints = mainDbPoints;
                            currentUser.points = mainDbPoints;
                            // æ›´æ–°å½“å‰ç”¨æˆ·å­˜å‚¨
                            localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));
                        } else {
                            userPoints = storedPoints;
                        }
                    } else {
                        console.log('é¡µé¢åŠ è½½ - ç”¨æˆ·ä¸åœ¨ä¸»æ•°æ®åº“ä¸­ï¼Œä½¿ç”¨å­˜å‚¨ç§¯åˆ†');
                        userPoints = currentUser.points || 0;
                    }

                    console.log('é¡µé¢åŠ è½½ - æœ€ç»ˆä½¿ç”¨ç§¯åˆ†:', userPoints);

                    await refreshUserInterface();
                } catch (error) {
                    console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
                    showAuthInterface();
                }
            } else {
                showAuthInterface();
            }
        }

        // åˆ·æ–°ç”¨æˆ·ç•Œé¢ï¼ˆç¡®ä¿ç§¯åˆ†æ˜¾ç¤ºæœ€æ–°ï¼‰
        async function refreshUserInterface() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('user-section').classList.remove('hidden');
            document.getElementById('login-prompt').classList.add('hidden');
            document.getElementById('upload-section').classList.remove('hidden');

            // å¼ºåˆ¶æ›´æ–°æ˜¾ç¤º
            const pointsElement = document.getElementById('user-points');
            const usernameElement = document.getElementById('user-username');

            pointsElement.textContent = userPoints;
            usernameElement.textContent = currentUser.username;

            console.log('ç•Œé¢åˆ·æ–° - æ˜¾ç¤ºç§¯åˆ†:', userPoints);

            // å¼ºåˆ¶é‡æ–°æ¸²æŸ“
            pointsElement.style.display = 'none';
            pointsElement.offsetHeight; // è§¦å‘é‡æ’
            pointsElement.style.display = '';
        }

        // æ˜¾ç¤ºç”¨æˆ·ç•Œé¢
        function showUserInterface() {
            refreshUserInterface();
        }

        // æ˜¾ç¤ºè®¤è¯ç•Œé¢
        function showAuthInterface() {
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('user-section').classList.add('hidden');
            document.getElementById('login-prompt').classList.remove('hidden');
            document.getElementById('upload-section').classList.add('hidden');
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ 
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            
            // æ‹–æ‹½ä¸Šä¼ 
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload({ target: { files } });
                }
            });

            // ç™»å½•è¡¨å•
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // æ³¨å†Œè¡¨å•
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        async function handleFileUpload(event) {
            const file = event.target.files?.[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > 10 * 1024 * 1024) {
                showError('æ–‡ä»¶å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„å›¾ç‰‡');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showError('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            // æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
            if (userPoints < 10) {
                showError(`ç§¯åˆ†ä¸è¶³ï¼éœ€è¦10ç§¯åˆ†ï¼Œå½“å‰åªæœ‰${userPoints}ç§¯åˆ†`);
                return;
            }

            try {
                showLoading();
                
                // ä¸Šä¼ å›¾ç‰‡
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetch('http://localhost:8787/jobs', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('ä¸Šä¼ å¤±è´¥');
                }

                const data = await response.json();
                currentJobId = data.id;

                // è½®è¯¢ä»»åŠ¡çŠ¶æ€
                await pollJobStatus(data.id);
                
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showError(`ä¸Šä¼ å¤±è´¥: ${error.message || 'è¯·é‡è¯•'}`);
                hideLoading();

                // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œæä¾›æ›´å…·ä½“çš„æç¤º
                if (error.message?.includes('fetch') || error.message?.includes('network')) {
                    showError('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ');
                }
            }
        }

        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        async function pollJobStatus(jobId) {
            const maxAttempts = 30;
            let attempts = 0;

            const poll = async () => {
                try {
                    const response = await fetch(`http://localhost:8787/jobs/${jobId}`);
                    if (!response.ok) {
                        throw new Error('è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥');
                    }

                    const job = await response.json();
                    
                    if (job.status === 'succeeded') {
                        console.log('ä»»åŠ¡æˆåŠŸï¼Œå‡†å¤‡æ‰£é™¤ç§¯åˆ†...');
                        // æ¶ˆè´¹ç§¯åˆ†
                        await consumePoints(10);

                        // æ˜¾ç¤ºç»“æœ
                        displayRecipe(job.recipe);
                        hideLoading();

                        console.log('ç§¯åˆ†æ‰£é™¤å®Œæˆï¼Œæ˜¾ç¤ºèœè°±ç»“æœ');
                    } else if (job.status === 'failed') {
                        console.error('ä»»åŠ¡å¤±è´¥:', job.error);
                        throw new Error(job.error?.message || 'å¤„ç†å¤±è´¥');
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        console.log(`ä»»åŠ¡è¿›è¡Œä¸­ï¼Œå°è¯• ${attempts}/${maxAttempts}...`);
                        setTimeout(poll, 2000);
                    } else {
                        throw new Error('å¤„ç†è¶…æ—¶');
                    }
                } catch (error) {
                    console.error('è½®è¯¢å¤±è´¥:', error);
                    showError('å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
                    hideLoading();
                }
            };

            poll();
        }

        // æ¶ˆè´¹ç§¯åˆ†
        async function consumePoints(points) {
            try {
                console.log('å¼€å§‹æ¶ˆè´¹ç§¯åˆ†:', points);

                // æ›´æ–°æœ¬åœ°å˜é‡
                userPoints -= points;
                currentUser.points = userPoints;

                // åŒæ­¥åˆ°ä¸»æ•°æ®åº“
                const users = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
                if (users[currentUser.username]) {
                    users[currentUser.username].points = userPoints;
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(users));
                    console.log('ä¸»æ•°æ®åº“ç§¯åˆ†å·²æ›´æ–°:', userPoints);
                }

                // æ›´æ–°å½“å‰ç”¨æˆ·å­˜å‚¨
                localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));

                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                document.getElementById('user-points').textContent = userPoints;

                console.log('ç§¯åˆ†æ¶ˆè´¹å®Œæˆï¼Œå‰©ä½™:', userPoints);

            } catch (error) {
                console.error('æ¶ˆè´¹ç§¯åˆ†å¤±è´¥:', error);
                showError('ç§¯åˆ†æ›´æ–°å¤±è´¥');
            }
        }

        // æ˜¾ç¤ºèœè°±
        function displayRecipe(recipe) {
            document.getElementById('recipeTitle').textContent = recipe.name || 'è¯†åˆ«èœå“';
            
            // æ˜¾ç¤ºé£Ÿæ
            const ingredientList = document.getElementById('ingredientList');
            ingredientList.innerHTML = '';
            recipe.ingredients?.forEach(ingredient => {
                const li = document.createElement('li');
                li.className = 'ingredient-item';
                li.textContent = ingredient.name;
                ingredientList.appendChild(li);
            });

            // æ˜¾ç¤ºæ­¥éª¤
            const stepList = document.getElementById('stepList');
            stepList.innerHTML = '';
            recipe.steps?.forEach((step, index) => {
                const li = document.createElement('li');
                li.className = 'step-item';
                li.innerHTML = `
                    <div class="step-number">${index + 1}</div>
                    <div class="step-text">${step}</div>
                `;
                stepList.appendChild(li);
            });

            document.getElementById('recipe-section').style.display = 'block';
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loading-section').classList.remove('hidden');
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('recipe-section').style.display = 'none';
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            document.getElementById('loading-section').classList.add('hidden');
            document.getElementById('upload-section').classList.remove('hidden');
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.main-content').insertBefore(errorDiv, document.querySelector('.main-content').firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.main-content').insertBefore(successDiv, document.querySelector('.main-content').firstChild);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // æœ¬åœ°ç™»å½•å¤„ç†
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                // ä»æœ¬åœ°å­˜å‚¨è·å–ç”¨æˆ·æ•°æ®
                const users = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
                const user = users[username];

                if (!user || user.password !== password) {
                    showError('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                    return;
                }

                console.log('ç™»å½•å‰ - ä¸»æ•°æ®åº“ç§¯åˆ†:', user.points);

                // è®¾ç½®å½“å‰ç”¨æˆ·ï¼Œä½¿ç”¨ä¸»æ•°æ®åº“çš„ç§¯åˆ†
                currentUser = { username: username, points: user.points };
                userPoints = user.points;

                console.log('ç™»å½•å - å½“å‰ç”¨æˆ·ç§¯åˆ†:', userPoints);

                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));

                // å¼ºåˆ¶åˆ·æ–°ç•Œé¢
                await refreshUserInterface();

                showSuccess('ç™»å½•æˆåŠŸï¼');
                hideModal('loginModal');

            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                showError('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æœ¬åœ°æ³¨å†Œå¤„ç†
        async function handleRegister(event) {
            event.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            if (password !== passwordConfirm) {
                showError('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }

            if (username.length < 3) {
                showError('ç”¨æˆ·åè‡³å°‘3ä¸ªå­—ç¬¦');
                return;
            }

            if (password.length < 6) {
                showError('å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦');
                return;
            }

            try {
                // è·å–ç°æœ‰ç”¨æˆ·æ•°æ®
                const users = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
                
                if (users[username]) {
                    showError('ç”¨æˆ·åå·²å­˜åœ¨');
                    return;
                }

                // åˆ›å»ºæ–°ç”¨æˆ·
                users[username] = {
                    password: password,
                    points: 100, // æ–°ç”¨æˆ·å¥–åŠ±100ç§¯åˆ†
                    createdAt: new Date().toISOString()
                };

                // ä¿å­˜ç”¨æˆ·æ•°æ®
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(users));

                // è®¾ç½®å½“å‰ç”¨æˆ·
                currentUser = { username: username, points: 100 };
                userPoints = 100;
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));
                
                showUserInterface();
                showSuccess('æ³¨å†ŒæˆåŠŸï¼æ‚¨è·å¾—äº†100ç§¯åˆ†å¥–åŠ±ï¼');
                hideModal('registerModal');
                
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error);
                showError('æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            currentUser = null;
            userPoints = 0;
            localStorage.removeItem(CURRENT_USER_KEY);
            showAuthInterface();
            showSuccess('å·²é€€å‡ºç™»å½•');
        }

        // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        function showLogin() {
            showModal('loginModal');
        }

        // æ˜¾ç¤ºæ³¨å†Œæ¨¡æ€æ¡†
        function showRegister() {
            showModal('registerModal');
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        // éšè—æ¨¡æ€æ¡†
        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
    </script>
</body>
</html>
