<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½èœè°±åŠ©æ‰‹</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.7/dist/iconify-icon.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* å…è®¸æ–‡æœ¬é€‰æ‹© */
        input, textarea, .step-text, .ingredient-item {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .points-display {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
        }

        .auth-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            /* ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ– */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px; /* iOSæ¨èçš„æœ€å°è§¦æ‘¸ç›®æ ‡ */
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .main-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .upload-zone {
            border: 2px dashed #ddd;
            border-radius: 15px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
            /* ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ– */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-zone.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        /* ç§»åŠ¨ç«¯è§¦æ‘¸åé¦ˆ */
        .upload-zone:active {
            transform: scale(0.98);
            background: #f0f4ff;
        }
        
        .btn:active {
            transform: scale(0.95);
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            color: #999;
            font-size: 0.9rem;
        }

        .recipe-display {
            display: none;
            margin-top: 2rem;
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .recipe-header {
            margin-bottom: 1rem;
        }

        .recipe-image-section {
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .recipe-image-container {
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }

        .recipe-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }

        .recipe-image:hover {
            transform: scale(1.02);
        }

        .recipe-info {
            flex: 1;
        }

        .image-loading {
            width: 100%;
            height: 300px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.9rem;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .image-error {
            width: 100%;
            height: 300px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }

        .image-error-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .header {
                padding: 0.75rem 1rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .logo {
                font-size: 1.2rem;
                flex: 1;
                min-width: 0;
            }
            
            .user-info {
                flex-direction: column;
                align-items: flex-end;
                gap: 0.5rem;
            }
            
            .points-display {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
            }
            
            .auth-buttons {
                flex-direction: column;
                gap: 0.3rem;
            }
            
            .btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .main-content {
                padding: 1.5rem;
                border-radius: 15px;
            }
            
            .upload-zone {
                padding: 2rem 1rem;
                margin-bottom: 1.5rem;
            }
            
            .upload-icon {
                font-size: 2.5rem;
            }
            
            .upload-text {
                font-size: 1.1rem;
            }
            
            .upload-hint {
                font-size: 0.85rem;
            }
            
            .recipe-image-container {
                max-width: 100%;
            }
            
            .recipe-image {
                height: 200px;
            }
            
            .image-loading,
            .image-error {
                height: 200px;
            }
            
            .recipe-title {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .recipe-content {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                display: flex;
                flex-direction: column;
            }
            
            .ingredients-section, .steps-section {
                padding: 1.25rem;
                margin-bottom: 0.5rem;
            }
            
            .ingredients-section {
                order: 1;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border-left: 4px solid #667eea;
            }
            
            .steps-section {
                order: 2;
                background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
                border-left: 4px solid #f39c12;
            }
            
            .section-title {
                font-size: 1.1rem;
                margin-bottom: 0.75rem;
            }
            
            .ingredient-item {
                padding: 0.5rem 0;
                font-size: 0.9rem;
                line-height: 1.4;
            }
            
            .step-item {
                padding: 0.75rem 0;
                gap: 0.75rem;
            }
            
            .step-number {
                width: 1.75rem;
                height: 1.75rem;
                font-size: 0.9rem;
            }
            
            .step-text {
                font-size: 0.9rem;
                line-height: 1.4;
            }
            
            .points-cost {
                padding: 0.75rem;
                font-size: 0.9rem;
                margin: 1rem 0;
            }
            
            .modal-content {
                width: 95%;
                padding: 1.5rem;
                margin: 1rem;
            }
            
            .modal-content input {
                padding: 0.8rem;
                font-size: 1rem;
            }
            
            .modal-content button {
                padding: 0.8rem;
                font-size: 1rem;
            }
        }
        
        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 480px) {
            .header {
                padding: 0.5rem 0.75rem;
            }
            
            .logo {
                font-size: 1rem;
            }
            
            .container {
                padding: 0.75rem;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .upload-zone {
                padding: 1.5rem 0.75rem;
                min-height: 100px;
            }
            
            .upload-icon {
                font-size: 2rem;
            }
            
            .upload-text {
                font-size: 1rem;
            }
            
            .recipe-image {
                height: 180px;
            }
            
            .image-loading,
            .image-error {
                height: 180px;
            }
            
            .recipe-title {
                font-size: 1.3rem;
            }
            
            .ingredients-section, .steps-section {
                padding: 1rem;
                margin-bottom: 0.75rem;
            }
            
            .ingredients-section {
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border-left: 3px solid #667eea;
            }
            
            .steps-section {
                background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
                border-left: 3px solid #f39c12;
            }
            
            .section-title {
                font-size: 1rem;
            }
            
            .ingredient-item {
                font-size: 0.85rem;
            }
            
            .step-text {
                font-size: 0.85rem;
            }
            
            .modal-content {
                padding: 1rem;
                width: 98%;
                margin: 0.5rem;
            }
        }
        
        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (max-width: 768px) and (orientation: landscape) {
            .header {
                padding: 0.5rem 1rem;
            }
            
            .container {
                padding: 0.5rem;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .upload-zone {
                padding: 1rem;
                min-height: 80px;
            }
            
            .recipe-image {
                height: 150px;
            }
            
            .image-loading,
            .image-error {
                height: 150px;
            }
            
            .recipe-content {
                gap: 1rem;
            }
            
            .ingredients-section, .steps-section {
                padding: 0.75rem;
                margin-bottom: 0.5rem;
            }
            
            .steps-section::before {
                display: none; /* æ¨ªå±æ—¶éšè—æ»šåŠ¨æç¤º */
            }
        }
        
        /* é«˜åˆ†è¾¨ç‡å±å¹•ä¼˜åŒ– */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .upload-icon,
            .loading-icon {
                -webkit-font-smoothing: antialiased;
            }
        }

        .recipe-title {
            font-size: 2rem;
            color: #333;
            margin-bottom: 0.5rem;
            text-align: left;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .recipe-title::before {
            content: "ğŸ½ï¸";
            font-size: 1.5rem;
        }

        .recipe-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .ingredients-section, .steps-section {
            background: #f8f9fa;
            padding: 1.25rem;
            border-radius: 15px;
        }

        .section-title {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* ç§»åŠ¨ç«¯æ»šåŠ¨æç¤º */
        @media (max-width: 768px) {
            .steps-section::before {
                content: "ğŸ‘‡ ä¸‹æ»‘æŸ¥çœ‹æ›´å¤šæ­¥éª¤";
                display: block;
                text-align: center;
                font-size: 0.8rem;
                color: #666;
                margin-bottom: 0.5rem;
                padding: 0.5rem;
                background: rgba(255, 255, 255, 0.7);
                border-radius: 8px;
                border: 1px dashed #ccc;
            }
        }

        .ingredient-list {
            list-style: none;
        }

        .ingredient-item {
            padding: 0.4rem 0;
            border-bottom: 1px solid #eee;
            font-size: 0.95rem;
        }

        .step-list {
            list-style: none;
        }

        .step-item {
            padding: 0.8rem 0;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 1rem;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-text {
            flex: 1;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .loading-icon {
            font-size: 2rem;
            color: #667eea;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: #e74c3c;
            text-align: center;
            padding: 1rem;
            background: #ffeaea;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .login-prompt {
            color: #666;
            text-align: center;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 2rem 0;
            border: 2px dashed #ddd;
        }

        .login-prompt iconify-icon {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .success {
            color: #27ae60;
            text-align: center;
            padding: 1rem;
            background: #eafaf1;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .hidden {
            display: none !important;
        }

        .points-cost {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨ -->
    <header class="header">
        <div class="logo">ğŸ³ æ™ºèƒ½èœè°±åŠ©æ‰‹</div>
        <div class="user-info">
            <!-- æœªç™»å½•çŠ¶æ€ -->
            <div id="auth-section">
                <div class="auth-buttons">
                    <button class="btn btn-primary" onclick="showLogin()">ç™»å½•</button>
                    <button class="btn btn-secondary" onclick="showRegister()">æ³¨å†Œ</button>
                </div>
            </div>
            <!-- å·²ç™»å½•çŠ¶æ€ -->
            <div id="user-section" class="hidden">
                <div class="points-display">
                    <iconify-icon icon="mdi:star"></iconify-icon>
                    <span id="user-points">0</span> ç§¯åˆ†
                </div>
                <div>
                    <span id="user-username">ç”¨æˆ·</span>
                    <button class="btn btn-secondary" onclick="logout()">é€€å‡º</button>
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹ -->
    <div class="container">
        <div class="main-content">
            <!-- æœªç™»å½•æç¤º -->
            <div id="login-prompt" class="login-prompt">
                <iconify-icon icon="mdi:lock"></iconify-icon>
                <div>è¯·å…ˆç™»å½•æˆ–æ³¨å†Œä»¥ä½¿ç”¨AIèœè°±åˆ†æåŠŸèƒ½</div>
            </div>

            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div id="upload-section" class="hidden">
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <div id="uploadPreview" style="display: none;">
                        <img id="previewImage" style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="color: #666; font-size: 0.9rem;">ç‚¹å‡»é‡æ–°é€‰æ‹©å›¾ç‰‡</div>
                    </div>
                    <div id="uploadPlaceholder">
                        <div class="upload-icon">
                            <iconify-icon icon="mdi:cloud-upload"></iconify-icon>
                        </div>
                        <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</div>
                        <div class="upload-hint">æ”¯æŒ JPGã€PNGã€WEBP æ ¼å¼ï¼Œæœ€å¤§ 10MB</div>
                    </div>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                
                <div class="points-cost">
                    <iconify-icon icon="mdi:information"></iconify-icon>
                    æ¯æ¬¡AIåˆ†ææ¶ˆè€— 10 ç§¯åˆ†
                </div>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loading-section" class="loading hidden">
                <div class="loading-icon">
                    <iconify-icon icon="mdi:loading"></iconify-icon>
                </div>
                <div>AIæ­£åœ¨åˆ†ææ‚¨çš„å›¾ç‰‡...</div>
            </div>

            <!-- èœè°±æ˜¾ç¤º -->
            <div id="recipe-section" class="recipe-display">
                <div class="recipe-header">
                    <div class="recipe-info">
                        <div class="recipe-title" id="recipeTitle"></div>
                    </div>
                </div>
                <div class="recipe-image-section">
                    <div id="recipeImageContainer">
                        <div class="image-loading" id="imageLoading">
                            <iconify-icon icon="mdi:loading" style="animation: spin 1s linear infinite;"></iconify-icon>
                            æ­£åœ¨åŠ è½½å›¾ç‰‡...
                        </div>
                    </div>
                </div>
                <div class="recipe-content">
                    <div class="ingredients-section">
                        <div class="section-title">
                            <iconify-icon icon="mdi:food"></iconify-icon>
                            ä¸»è¦é£Ÿæ
                        </div>
                        <ul class="ingredient-list" id="ingredientList"></ul>
                    </div>
                    <div class="steps-section">
                        <div class="section-title">
                            <iconify-icon icon="mdi:chef-hat"></iconify-icon>
                            çƒ¹é¥ªæ­¥éª¤
                        </div>
                        <ul class="step-list" id="stepList"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="loginModal" class="modal hidden">
        <div class="modal-content">
            <h2>ç™»å½•</h2>
            <div id="loginError" class="modal-error hidden"></div>
            <form id="loginForm">
                <input type="text" placeholder="ç”¨æˆ·å" id="loginUsername" required>
                <input type="password" placeholder="å¯†ç " id="loginPassword" required>
                <button type="submit">ç™»å½•</button>
            </form>
        </div>
    </div>

    <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
    <div id="registerModal" class="modal hidden">
        <div class="modal-content">
            <h2>æ³¨å†Œ</h2>
            <div id="registerError" class="modal-error hidden"></div>
            <form id="registerForm">
                <input type="text" placeholder="ç”¨æˆ·å" id="registerUsername" required>
                <input type="password" placeholder="å¯†ç " id="registerPassword" required>
                <input type="password" placeholder="ç¡®è®¤å¯†ç " id="registerPasswordConfirm" required>
                <button type="submit">æ³¨å†Œ</button>
            </form>
        </div>
    </div>

    <script>
        // æ£€æŸ¥Supabaseæ˜¯å¦åŠ è½½æˆåŠŸ
        if (typeof supabase === 'undefined') {
            console.error('Supabaseåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
            document.body.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #e74c3c;">
                    <h2>âš ï¸ ç½‘ç»œè¿æ¥é—®é¢˜</h2>
                    <p>æ— æ³•åŠ è½½å¿…è¦çš„åº“æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢</p>
                    <button onclick="location.reload()" style="padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">åˆ·æ–°é¡µé¢</button>
                </div>
            `
        }

        // Supabaseé…ç½®
        const SUPABASE_URL = 'https://bqbtkaljxsmdcpedrerg.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxYnRrYWxqeHNtZGNwZWRyZXJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NDg0NDUsImV4cCI6MjA3NDAyNDQ0NX0._XIcJcSg_00b_iOs90QM5GNaKAg5_LEHGDrexDTFcMQ'
        
        let supabaseClient = null
        try {
            const { createClient } = supabase
            supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY)
        } catch (error) {
            console.error('Supabaseåˆå§‹åŒ–å¤±è´¥:', error)
        }

        // API åŸºåœ°å€ï¼ˆå…¼å®¹ file:// æ‰“å¼€å’Œ http:// æœåŠ¡ï¼‰
        const API_BASE = (location.protocol.startsWith('http') ? `${location.protocol}//${location.host}` : 'http://localhost:8787')

        // å…¨å±€å˜é‡
        let currentUser = null
        let userPoints = 0
        let currentJobId = null

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯çŠ¶æ€
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuthState()
            setupEventListeners()
        })

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuthState() {
            if (!supabaseClient) {
                console.error('Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–')
                showAuthInterface()
                return
            }
            
            try {
                // ä½¿ç”¨getSessionæ¥æ£€æŸ¥è®¤è¯çŠ¶æ€ï¼Œè¿™æ ·æ›´å¯é 
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession()
                
                if (sessionError || !session) {
                    console.log('æ²¡æœ‰æœ‰æ•ˆçš„sessionï¼Œæ˜¾ç¤ºè®¤è¯ç•Œé¢')
                    showAuthInterface()
                    return
                }
                
                console.log('æ‰¾åˆ°æœ‰æ•ˆsessionï¼Œç”¨æˆ·ID:', session.user.id)
                currentUser = session.user
                await loadUserData()
                showUserInterface()
            } catch (error) {
                console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error)
                showAuthInterface()
            }
        }

        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUserData() {
            try {
                // è·å–å½“å‰session
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession()
                
                if (sessionError || !session) {
                    console.error('è·å–sessionå¤±è´¥:', sessionError)
                    userPoints = 0
                    document.getElementById('user-points').textContent = '0'
                    document.getElementById('user-username').textContent = 'ç”¨æˆ·'
                    return
                }

                console.log('å½“å‰sessionç”¨æˆ·ID:', session.user.id)
                console.log('ä½¿ç”¨access_token:', session.access_token.substring(0, 20) + '...')

                const response = await fetch(`${API_BASE}/auth/user`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`,
                        'Content-Type': 'application/json'
                    }
                })
                
                console.log('ç”¨æˆ·ä¿¡æ¯APIå“åº”çŠ¶æ€:', response.status)
                
                if (response.ok) {
                    const data = await response.json()
                    console.log('ç”¨æˆ·ä¿¡æ¯APIè¿”å›æ•°æ®:', data)

                    // ç¡®ä¿ç§¯åˆ†æ˜¯æœ‰æ•ˆæ•°å­—
                    userPoints = Math.max(0, parseInt(data.points) || 0)
                    const username = data.username && data.username !== 'ç”¨æˆ·' ? data.username : 'ç”¨æˆ·'

                    console.log('å‡†å¤‡æ›´æ–°DOM - ç”¨æˆ·å:', username, 'ç§¯åˆ†:', userPoints)

                    // æ›´æ–°DOMï¼Œç¡®ä¿å…ƒç´ å­˜åœ¨
                    const pointsElement = document.getElementById('user-points')
                    const usernameElement = document.getElementById('user-username')

                    if (pointsElement) {
                        pointsElement.textContent = userPoints
                    }
                    if (usernameElement) {
                        usernameElement.textContent = username
                    }

                    console.log('DOMå·²æ›´æ–° - ç”¨æˆ·å:', usernameElement?.textContent, 'ç§¯åˆ†:', pointsElement?.textContent)

                    // å¦‚æœç§¯åˆ†ä¸º0ï¼Œæ˜¾ç¤ºæé†’
                    if (userPoints === 0) {
                        showInsufficientPointsAlert()
                    }
                } else {
                    const errorText = await response.text()
                    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', response.status, response.statusText, errorText)

                    // è®¾ç½®é»˜è®¤å€¼ï¼Œç¡®ä¿å…ƒç´ å­˜åœ¨
                    userPoints = 0
                    const pointsElement = document.getElementById('user-points')
                    const usernameElement = document.getElementById('user-username')

                    if (pointsElement) {
                        pointsElement.textContent = '0'
                    }
                    if (usernameElement) {
                        usernameElement.textContent = 'ç”¨æˆ·'
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error)
                // è®¾ç½®é»˜è®¤å€¼ï¼Œç¡®ä¿å…ƒç´ å­˜åœ¨
                userPoints = 0
                const pointsElement = document.getElementById('user-points')
                const usernameElement = document.getElementById('user-username')

                if (pointsElement) {
                    pointsElement.textContent = '0'
                }
                if (usernameElement) {
                    usernameElement.textContent = 'ç”¨æˆ·'
                }
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·ç•Œé¢
        function showUserInterface() {
            document.getElementById('auth-section').classList.add('hidden')
            document.getElementById('user-section').classList.remove('hidden')
            document.getElementById('login-prompt').classList.add('hidden')
            document.getElementById('upload-section').classList.remove('hidden')
            
            console.log('æ˜¾ç¤ºç”¨æˆ·ç•Œé¢ï¼Œå½“å‰ç§¯åˆ†:', userPoints)
            console.log('å½“å‰ç”¨æˆ·å:', document.getElementById('user-username').textContent)
        }

        // æ˜¾ç¤ºè®¤è¯ç•Œé¢
        function showAuthInterface() {
            document.getElementById('auth-section').classList.remove('hidden')
            document.getElementById('user-section').classList.add('hidden')
            document.getElementById('login-prompt').classList.remove('hidden')
            document.getElementById('upload-section').classList.add('hidden')
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ 
            document.getElementById('fileInput').addEventListener('change', handleFileUpload)
            
            // æ‹–æ‹½ä¸Šä¼ 
            const uploadZone = document.getElementById('uploadZone')
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault()
                uploadZone.classList.add('dragover')
            })
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover')
            })
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault()
                uploadZone.classList.remove('dragover')
                const files = e.dataTransfer.files
                if (files.length > 0) {
                    handleFileUpload({ target: { files } })
                }
            })

            // ç™»å½•è¡¨å•
            document.getElementById('loginForm').addEventListener('submit', handleLogin)
            
            // æ³¨å†Œè¡¨å•
            document.getElementById('registerForm').addEventListener('submit', handleRegister)
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        async function handleFileUpload(event) {
            const file = event.target.files?.[0]
            if (!file) return

            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (file.size > 10 * 1024 * 1024) {
                showError('æ–‡ä»¶å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„å›¾ç‰‡')
                return
            }

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showError('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶')
                return
            }

            // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
            showImagePreview(file)

            // æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
            const pointsCheck = await checkPoints(10)
            if (!pointsCheck.hasEnough) {
                showError(`ç§¯åˆ†ä¸è¶³ï¼éœ€è¦10ç§¯åˆ†ï¼Œå½“å‰åªæœ‰${pointsCheck.currentPoints}ç§¯åˆ†`)
                showInsufficientPointsAlert()
                return
            }

            try {
                showLoading()
                
                // è·å–å½“å‰session
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession()
                
                if (sessionError || !session) {
                    showError('è¯·å…ˆç™»å½•')
                    return
                }
                
                // ä¸Šä¼ å›¾ç‰‡
                const formData = new FormData()
                formData.append('image', file)
                
                console.log('ğŸ“¤ å¼€å§‹ä¸Šä¼ å›¾ç‰‡åˆ°:', `${API_BASE}/jobs`)
                console.log('ğŸ“ æ–‡ä»¶ä¿¡æ¯:', {
                    name: file.name,
                    size: file.size,
                    type: file.type
                })
                
                const response = await fetch(`${API_BASE}/jobs`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: formData
                })

                console.log('ğŸ“¡ ä¸Šä¼ å“åº”çŠ¶æ€:', response.status, response.statusText)

                if (!response.ok) {
                    const errorText = await response.text()
                    console.error('âŒ ä¸Šä¼ å¤±è´¥:', {
                        status: response.status,
                        statusText: response.statusText,
                        errorText: errorText
                    })
                    throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status} ${response.statusText}`)
                }

                const data = await response.json()
                console.log('âœ… ä¸Šä¼ æˆåŠŸï¼Œä»»åŠ¡ID:', data.id)
                currentJobId = data.id

                // è½®è¯¢ä»»åŠ¡çŠ¶æ€
                await pollJobStatus(data.id)
                
            } catch (error) {
                console.error('âŒ ä¸Šä¼ å¤±è´¥:', error)
                showError(`ä¸Šä¼ å¤±è´¥: ${error.message}`)
                hideLoading()
            }
        }

        // æ£€æŸ¥ç§¯åˆ†
        async function checkPoints(requiredPoints) {
            try {
                // è·å–å½“å‰session
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession()
                
                if (sessionError || !session) {
                    console.error('è·å–sessionå¤±è´¥:', sessionError)
                    return { hasEnough: false, currentPoints: 0 }
                }

                console.log('æ£€æŸ¥ç§¯åˆ†ï¼Œéœ€è¦:', requiredPoints, 'ç”¨æˆ·ID:', session.user.id)

                const response = await fetch(`${API_BASE}/auth/check-points`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({ requiredPoints })
                })

                console.log('ç§¯åˆ†æ£€æŸ¥APIå“åº”çŠ¶æ€:', response.status)

                if (response.ok) {
                    const result = await response.json()
                    console.log('ç§¯åˆ†æ£€æŸ¥ç»“æœ:', result)
                    return result
                } else {
                    const errorText = await response.text()
                    console.error('ç§¯åˆ†æ£€æŸ¥å¤±è´¥:', response.status, response.statusText, errorText)
                    return { hasEnough: false, currentPoints: 0 }
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç§¯åˆ†å¤±è´¥:', error)
                return { hasEnough: false, currentPoints: 0 }
            }
        }

        // æ˜¾ç¤ºç§¯åˆ†ä¸è¶³æé†’
        function showInsufficientPointsAlert() {
            const alertDiv = document.createElement('div')
            alertDiv.className = 'error'
            alertDiv.innerHTML = `
                <div style="text-align: center; padding: 1rem;">
                    <h3 style="color: #e74c3c; margin: 0 0 1rem 0;">âš ï¸ ç§¯åˆ†ä¸è¶³</h3>
                    <p style="margin: 0 0 1rem 0;">æ‚¨çš„ç§¯åˆ†å·²ç”¨å®Œï¼Œæ— æ³•ç»§ç»­ä½¿ç”¨AIåˆ†æåŠŸèƒ½ã€‚</p>
                    <p style="margin: 0; color: #666;">è¯·ç­‰å¾…ç§¯åˆ†æ¢å¤æˆ–è”ç³»ç®¡ç†å‘˜è·å–æ›´å¤šç§¯åˆ†ã€‚</p>
                </div>
            `
            
            // æ’å…¥åˆ°é¡µé¢é¡¶éƒ¨ï¼ˆä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„é€‰æ‹©å™¨ï¼‰
            const mainContent = document.querySelector('.main-content')
            if (mainContent) {
                mainContent.insertBefore(alertDiv, mainContent.firstChild)
            }
            
            // ç¦ç”¨ä¸Šä¼ åŠŸèƒ½
            const uploadButton = document.querySelector('input[type="file"]')
            if (uploadButton) {
                uploadButton.disabled = true
                uploadButton.style.opacity = '0.5'
            }
            
            // 5ç§’åè‡ªåŠ¨éšè—æé†’
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv)
                }
            }, 5000)
        }

        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        async function pollJobStatus(jobId) {
            const maxAttempts = 30
            let attempts = 0

            const poll = async () => {
                try {
                    const response = await fetch(`${API_BASE}/jobs/${jobId}`)
                    if (!response.ok) {
                        throw new Error('è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥')
                    }

                    const job = await response.json()
                    
                    if (job.status === 'succeeded') {
                        // ç§¯åˆ†æ‰£é™¤ç”±åç«¯å®Œæˆï¼Œè¿™é‡Œåªåˆ·æ–°æ•°æ®ï¼Œé¿å…é‡å¤æ‰£é™¤
                        await loadUserData()
                        
                        // æ˜¾ç¤ºç»“æœ
                        displayRecipe(job.recipe)
                        
                        // æ˜¾ç¤ºä¸Šä¼ çš„å›¾ç‰‡
                        if (job.inputImageUrl) {
                            displayRecipeImage(job.inputImageUrl)
                        }
                        
                        hideLoading()
                    } else if (job.status === 'failed') {
                        throw new Error(job.error?.message || 'å¤„ç†å¤±è´¥')
                    } else if (attempts < maxAttempts) {
                        attempts++
                        setTimeout(poll, 2000)
                    } else {
                        throw new Error('å¤„ç†è¶…æ—¶')
                    }
                } catch (error) {
                    console.error('è½®è¯¢å¤±è´¥:', error)
                    showError('å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•')
                    hideLoading()
                }
            }

            poll()
        }

        // æ¶ˆè´¹ç§¯åˆ†
        async function consumePoints(points) {
            try {
                const response = await fetch(`${API_BASE}/auth/consume-points`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await supabaseClient.auth.getSession().then(s => s.data.session?.access_token)}`
                    },
                    body: JSON.stringify({ points })
                })

                if (response.ok) {
                    const data = await response.json()
                    userPoints = data.newPoints
                    document.getElementById('user-points').textContent = userPoints
                }
            } catch (error) {
                console.error('æ¶ˆè´¹ç§¯åˆ†å¤±è´¥:', error)
            }
        }

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
        function showImagePreview(file) {
            const reader = new FileReader()
            reader.onload = function(e) {
                const previewImage = document.getElementById('previewImage')
                const uploadPreview = document.getElementById('uploadPreview')
                const uploadPlaceholder = document.getElementById('uploadPlaceholder')
                
                previewImage.src = e.target.result
                uploadPreview.style.display = 'block'
                uploadPlaceholder.style.display = 'none'
            }
            reader.readAsDataURL(file)
        }

        // é‡ç½®ä¸Šä¼ åŒºåŸŸ
        function resetUploadArea() {
            const uploadPreview = document.getElementById('uploadPreview')
            const uploadPlaceholder = document.getElementById('uploadPlaceholder')
            const fileInput = document.getElementById('fileInput')
            
            uploadPreview.style.display = 'none'
            uploadPlaceholder.style.display = 'block'
            fileInput.value = ''
        }

        // æ˜¾ç¤ºèœè°±
        function displayRecipe(recipe) {
            document.getElementById('recipeTitle').textContent = recipe.name || 'è¯†åˆ«èœå“'
            
            // æ˜¾ç¤ºé£Ÿæ
            const ingredientList = document.getElementById('ingredientList')
            ingredientList.innerHTML = ''
            recipe.ingredients?.forEach(ingredient => {
                const li = document.createElement('li')
                li.className = 'ingredient-item'
                li.textContent = ingredient.name
                ingredientList.appendChild(li)
            })

            // æ˜¾ç¤ºæ­¥éª¤
            const stepList = document.getElementById('stepList')
            stepList.innerHTML = ''
            recipe.steps?.forEach((step, index) => {
                const li = document.createElement('li')
                li.className = 'step-item'
                li.innerHTML = `
                    <div class="step-number">${index + 1}</div>
                    <div class="step-text">${step}</div>
                `
                stepList.appendChild(li)
            })

            document.getElementById('recipe-section').style.display = 'block'
        }

        // æ˜¾ç¤ºèœè°±å›¾ç‰‡
        function displayRecipeImage(imageUrl) {
            const imageContainer = document.getElementById('recipeImageContainer')
            const imageLoading = document.getElementById('imageLoading')
            
            if (!imageUrl) {
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                imageContainer.innerHTML = `
                    <div class="image-error">
                        <div class="image-error-icon">ğŸ“·</div>
                        <div>å›¾ç‰‡åŠ è½½å¤±è´¥</div>
                    </div>
                `
                return
            }

            // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
            const img = document.createElement('img')
            img.className = 'recipe-image'
            img.alt = 'èœå“å›¾ç‰‡'
            
            // å›¾ç‰‡åŠ è½½æˆåŠŸ
            img.onload = function() {
                imageContainer.innerHTML = ''
                imageContainer.appendChild(img)
            }
            
            // å›¾ç‰‡åŠ è½½å¤±è´¥
            img.onerror = function() {
                imageContainer.innerHTML = `
                    <div class="image-error">
                        <div class="image-error-icon">âŒ</div>
                        <div>å›¾ç‰‡åŠ è½½å¤±è´¥</div>
                    </div>
                `
            }
            
            // å¼€å§‹åŠ è½½å›¾ç‰‡
            img.src = imageUrl
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loading-section').classList.remove('hidden')
            document.getElementById('upload-section').classList.add('hidden')
            document.getElementById('recipe-section').style.display = 'none'
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            document.getElementById('loading-section').classList.add('hidden')
            document.getElementById('upload-section').classList.remove('hidden')
            // é‡ç½®ä¸Šä¼ åŒºåŸŸï¼Œå‡†å¤‡ä¸‹æ¬¡ä¸Šä¼ 
            resetUploadArea()
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorDiv = document.createElement('div')
            errorDiv.className = 'error'
            errorDiv.textContent = message
            document.querySelector('.main-content').insertBefore(errorDiv, document.querySelector('.main-content').firstChild)
            
            setTimeout(() => {
                errorDiv.remove()
            }, 5000)
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            const successDiv = document.createElement('div')
            successDiv.className = 'success'
            successDiv.textContent = message
            document.querySelector('.main-content').insertBefore(successDiv, document.querySelector('.main-content').firstChild)
            
            setTimeout(() => {
                successDiv.remove()
            }, 3000)
        }

        // ç™»å½•å¤„ç†
        async function handleLogin(event) {
            event.preventDefault()
            const username = document.getElementById('loginUsername').value
            const password = document.getElementById('loginPassword').value

            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
            hideModalError('loginError')

            if (!supabaseClient) {
                showModalError('loginError', 'ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•')
                return
            }

            try {
                // ä½¿ç”¨ç”¨æˆ·åä½œä¸ºé‚®ç®±ï¼Œæ·»åŠ å›ºå®šåŸŸå
                const email = `${username}@cookapp.local`
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                })

                if (error) {
                    console.error('ç™»å½•é”™è¯¯:', error)
                    // å¦‚æœæ˜¯é‚®ç®±æœªç¡®è®¤é”™è¯¯ï¼Œå°è¯•è‡ªåŠ¨ç¡®è®¤
                    if (error.message.includes('Email not confirmed')) {
                        showModalError('loginError', 'ç™»å½•å¤±è´¥ï¼šè¯·å…ˆæ³¨å†Œè´¦æˆ·')
                        return
                    } else if (error.message.includes('Invalid login credentials') || error.message.includes('invalid credentials')) {
                        showModalError('loginError', 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¯·æ£€æŸ¥åé‡è¯•')
                    } else if (error.message.includes('User not found')) {
                        showModalError('loginError', 'ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ')
                        // è‡ªåŠ¨åˆ‡æ¢åˆ°æ³¨å†Œæ¨¡å¼
                        setTimeout(() => {
                            hideModal('loginModal')
                            showModal('registerModal')
                            document.getElementById('registerUsername').value = username
                        }, 2000)
                    } else {
                        showModalError('loginError', 'ç™»å½•å¤±è´¥ï¼š' + error.message)
                    }
                    return
                }

                currentUser = data.user
                console.log('ç™»å½•æˆåŠŸï¼Œç”¨æˆ·ID:', currentUser.id)
                
                // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿sessionå®Œå…¨å»ºç«‹
                setTimeout(async () => {
                    await loadUserData()
                    showUserInterface()
                    showModalSuccess('loginError', 'ç™»å½•æˆåŠŸï¼')
                    setTimeout(() => {
                        hideModal('loginModal')
                    }, 1000)
                }, 500)
            } catch (error) {
                showModalError('loginError', 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•')
            }
        }

        // æ³¨å†Œå¤„ç†
        async function handleRegister(event) {
            event.preventDefault()
            const username = document.getElementById('registerUsername').value
            const password = document.getElementById('registerPassword').value
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value

            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
            hideModalError('registerError')

            if (password !== passwordConfirm) {
                showModalError('registerError', 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´')
                return
            }

            if (!supabaseClient) {
                showModalError('registerError', 'ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•')
                return
            }

            try {
                // ä½¿ç”¨ç”¨æˆ·åä½œä¸ºé‚®ç®±ï¼Œæ·»åŠ å›ºå®šåŸŸå
                const email = `${username}@cookapp.local`
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: { username: username },
                        emailRedirectTo: undefined // ç¦ç”¨é‚®ç®±é‡å®šå‘
                    }
                })

                if (error) {
                    console.error('æ³¨å†Œé”™è¯¯:', error)
                    if (error.message.includes('already registered') || error.message.includes('already been registered') || error.message.includes('User already registered')) {
                        showModalError('registerError', 'ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·å°è¯•å…¶ä»–ç”¨æˆ·å')
                        // è‡ªåŠ¨åˆ‡æ¢åˆ°ç™»å½•æ¨¡å¼
                        setTimeout(() => {
                            hideModal('registerModal')
                            showModal('loginModal')
                            document.getElementById('loginUsername').value = username
                        }, 2000)
                    } else if (error.message.includes('Password should be at least')) {
                        showModalError('registerError', 'å¯†ç é•¿åº¦è‡³å°‘6ä½')
                    } else {
                        showModalError('registerError', 'æ³¨å†Œå¤±è´¥ï¼š' + error.message)
                    }
                    return
                }

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åˆ›å»ºæˆåŠŸ
                if (data.user) {
                    // ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼Œç›´æ¥ç™»å½•
                    currentUser = data.user
                    console.log('æ³¨å†ŒæˆåŠŸï¼Œç”¨æˆ·ID:', currentUser.id)
                    
                    // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿sessionå®Œå…¨å»ºç«‹
                    setTimeout(async () => {
                        await loadUserData()
                        showUserInterface()
                        showModalSuccess('registerError', 'æ³¨å†ŒæˆåŠŸï¼æ‚¨è·å¾—äº†100ç§¯åˆ†å¥–åŠ±ï¼')
                        setTimeout(() => {
                            hideModal('registerModal')
                        }, 1000)
                    }, 500)
                } else {
                    showModalError('registerError', 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•')
                }
            } catch (error) {
                showModalError('registerError', 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•')
            }
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            if (!supabaseClient) {
                currentUser = null
                userPoints = 0
                showAuthInterface()
                showSuccess('å·²é€€å‡ºç™»å½•')
                return
            }
            
            try {
                await supabaseClient.auth.signOut()
                currentUser = null
                userPoints = 0
                showAuthInterface()
                showSuccess('å·²é€€å‡ºç™»å½•')
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error)
            }
        }

        // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        function showLogin() {
            showModal('loginModal')
        }

        // æ˜¾ç¤ºæ³¨å†Œæ¨¡æ€æ¡†
        function showRegister() {
            showModal('registerModal')
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden')
        }

        // éšè—æ¨¡æ€æ¡†
        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden')
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†é”™è¯¯ä¿¡æ¯
        function showModalError(errorId, message) {
            const errorElement = document.getElementById(errorId)
            errorElement.textContent = message
            errorElement.className = 'modal-error'
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†æˆåŠŸä¿¡æ¯
        function showModalSuccess(errorId, message) {
            const errorElement = document.getElementById(errorId)
            errorElement.textContent = message
            errorElement.className = 'modal-success'
        }

        // éšè—æ¨¡æ€æ¡†é”™è¯¯ä¿¡æ¯
        function hideModalError(errorId) {
            const errorElement = document.getElementById(errorId)
            errorElement.className = 'modal-error hidden'
        }

    </script>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-content h2 {
            margin-bottom: 1rem;
            text-align: center;
        }

        .modal-content input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
            font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .modal-content button {
            width: 100%;
            padding: 0.75rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .modal-error {
            background: #ffeaea;
            color: #e74c3c;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 0.9rem;
            border: 1px solid #f5c6cb;
        }

        .modal-success {
            background: #eafaf1;
            color: #27ae60;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 0.9rem;
            border: 1px solid #c3e6cb;
        }
    </style>
</body>
</html>
